# Features Migration - Seed All Features from feature-docs.ts

## Overview

This migration ensures all features defined in `src/lib/feature-docs.ts` are present in the database, even after a database reset. The migration uses `INSERT ... ON DUPLICATE KEY UPDATE` to gracefully handle existing features.

## What This Migration Does

1. **Reads all features** from `src/lib/feature-docs.ts` (33 features total)
2. **Creates FeatureFlag records** in the database with:
   - `name`: The feature key (e.g., `analytics_dashboard`)
   - `displayName`: The feature title
   - `description`: The feature overview
   - `category`: Feature category (analytics, marketing, operations, etc.)
   - `tier`: Feature tier (FREE, PRO, ENTERPRISE)
   - `enabled`: Defaults to `false` (superadmin must enable)
3. **Updates existing features** if they already exist (based on unique `name` field)
4. **Preserves existing enabled status** - does not change `enabled` field on updates

## Migration File

**Location**: `prisma/migrations/[timestamp]_seed_all_features/migration.sql`

**Generated by**: `scripts/generate-features-migration.ts`

## How to Apply

### Option 1: Using Prisma Migrate (Recommended)

```bash
# Apply the migration
npx prisma migrate deploy

# Or for development
npx prisma migrate dev
```

### Option 2: Using the Seed Script

```bash
# Run the TypeScript seed script directly
npx tsx scripts/seed-all-features.ts
```

## Features Included

The migration seeds **33 features** from `feature-docs.ts`, including:

### Analytics (5 features)
- analytics_dashboard
- custom_reports
- sales_reports
- customer_analytics
- product_performance

### Marketing (7 features)
- abandoned_cart
- cms
- template_manager
- seo_toolkit
- exit_intent_popups
- email_campaigns
- flash_sales

### Operations (12 features)
- refund_management
- inventory_management
- inventory_tracking
- bulk_operations
- activity_log
- multi_admin
- invoice_generator
- product_import_export
- customer_segments
- advanced_shipping
- checkout_customization
- pos_system

### Customer Experience (5 features)
- loyalty_program
- wishlist
- advanced_reviews
- advanced_search
- customer_account_features

### Financial (1 feature)
- multi_currency

### Sales (1 feature)
- product_customization

### Other (2 features)
- live_chat
- product_recommendations

## Important Notes

1. **Enabled Status**: All features default to `enabled: false`. Only SUPERADMIN can enable features via `/admin/features`.

2. **Idempotent**: The migration is safe to run multiple times. It uses `ON DUPLICATE KEY UPDATE` to update existing features without errors.

3. **Source of Truth**: `src/lib/feature-docs.ts` is the source of truth for feature definitions. If you add new features to `feature-docs.ts`, regenerate the migration.

4. **Regenerating the Migration**: If you add new features to `feature-docs.ts`, run:
   ```bash
   npx tsx scripts/generate-features-migration.ts
   ```
   This will create a new migration with all current features.

## Troubleshooting

### Migration Fails with Duplicate Key Error

This shouldn't happen with `ON DUPLICATE KEY UPDATE`, but if it does:
- Check that the `name` field is unique in your database
- Verify the migration SQL syntax is correct for MySQL

### Features Not Showing in /admin/features

1. Ensure the migration has been applied: `npx prisma migrate status`
2. Check that features exist in the database: `npx prisma studio` â†’ FeatureFlag table
3. Verify you're logged in as SUPERADMIN

### Need to Update Feature Descriptions

1. Update `src/lib/feature-docs.ts`
2. Regenerate the migration: `npx tsx scripts/generate-features-migration.ts`
3. Apply the new migration: `npx prisma migrate dev`

## Related Files

- `src/lib/feature-docs.ts` - Source of truth for feature definitions
- `scripts/generate-features-migration.ts` - Script to generate migration SQL
- `scripts/seed-all-features.ts` - Alternative TypeScript seed script
- `src/app/admin/(protected)/features/page.tsx` - Admin UI for managing features
- `src/app/api/features/route.ts` - API endpoint for features

