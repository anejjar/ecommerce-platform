{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 112, "column": 0}, "map": {"version":3,"sources":["file:///C:/laragon/www/claude/ecommerce-platform/src/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from '@prisma/client';\n\nconst globalForPrisma = globalThis as unknown as {\n  prisma: PrismaClient | undefined;\n};\n\nexport const prisma =\n  globalForPrisma.prisma ??\n  new PrismaClient({\n    log: ['query'],\n  });\n\nif (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma;\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,kBAAkB;AAIjB,MAAM,SACX,gBAAgB,MAAM,IACtB,IAAI,6IAAY,CAAC;IACf,KAAK;QAAC;KAAQ;AAChB;AAEF,wCAA2C,gBAAgB,MAAM,GAAG"}},
    {"offset": {"line": 129, "column": 0}, "map": {"version":3,"sources":["file:///C:/laragon/www/claude/ecommerce-platform/src/lib/auth.ts"],"sourcesContent":["import { NextAuthOptions } from 'next-auth';\nimport CredentialsProvider from 'next-auth/providers/credentials';\nimport { PrismaAdapter } from '@next-auth/prisma-adapter';\nimport { prisma } from './prisma';\nimport { compare } from 'bcryptjs';\n\nexport const authOptions: NextAuthOptions = {\n  adapter: PrismaAdapter(prisma),\n  session: {\n    strategy: 'jwt',\n  },\n  pages: {\n    signIn: '/admin/login',\n  },\n  providers: [\n    CredentialsProvider({\n      name: 'credentials',\n      credentials: {\n        email: { label: 'Email', type: 'email' },\n        password: { label: 'Password', type: 'password' },\n      },\n      async authorize(credentials) {\n        if (!credentials?.email || !credentials?.password) {\n          return null;\n        }\n\n        const user = await prisma.user.findUnique({\n          where: {\n            email: credentials.email,\n          },\n        });\n\n        if (!user || !user.password) {\n          return null;\n        }\n\n        const isPasswordValid = await compare(\n          credentials.password,\n          user.password\n        );\n\n        if (!isPasswordValid) {\n          return null;\n        }\n\n        return {\n          id: user.id,\n          email: user.email,\n          name: user.name,\n          role: user.role,\n        };\n      },\n    }),\n  ],\n  callbacks: {\n    async jwt({ token, user, trigger }) {\n      if (user) {\n        return {\n          ...token,\n          id: user.id,\n          role: user.role,\n        };\n      }\n\n      // Validate session hasn't been invalidated\n      if (token.id) {\n        const dbUser = await prisma.user.findUnique({\n          where: { id: token.id as string },\n          select: { sessionsInvalidatedAt: true, role: true },\n        });\n\n        if (dbUser) {\n          // Check if JWT was issued before sessions were invalidated\n          if (dbUser.sessionsInvalidatedAt) {\n            const tokenIssuedAt = token.iat ? token.iat * 1000 : 0; // Convert to milliseconds\n            const invalidatedAt = new Date(dbUser.sessionsInvalidatedAt).getTime();\n\n            if (tokenIssuedAt < invalidatedAt) {\n              // Session has been invalidated - return null to force re-login\n              return null as any;\n            }\n          }\n\n          // Update role in token if it changed\n          token.role = dbUser.role;\n        } else {\n          // User no longer exists\n          return null as any;\n        }\n      }\n\n      return token;\n    },\n    async session({ session, token }) {\n      // If token is null, session is invalid\n      if (!token) {\n        return null as any;\n      }\n\n      return {\n        ...session,\n        user: {\n          ...session.user,\n          id: token.id,\n          role: token.role,\n        },\n      };\n    },\n  },\n};\n"],"names":[],"mappings":";;;;AACA;AACA;AACA;AACA;;;;;AAEO,MAAM,cAA+B;IAC1C,SAAS,IAAA,uLAAa,EAAC,gIAAM;IAC7B,SAAS;QACP,UAAU;IACZ;IACA,OAAO;QACL,QAAQ;IACV;IACA,WAAW;QACT,IAAA,qKAAmB,EAAC;YAClB,MAAM;YACN,aAAa;gBACX,OAAO;oBAAE,OAAO;oBAAS,MAAM;gBAAQ;gBACvC,UAAU;oBAAE,OAAO;oBAAY,MAAM;gBAAW;YAClD;YACA,MAAM,WAAU,WAAW;gBACzB,IAAI,CAAC,aAAa,SAAS,CAAC,aAAa,UAAU;oBACjD,OAAO;gBACT;gBAEA,MAAM,OAAO,MAAM,gIAAM,CAAC,IAAI,CAAC,UAAU,CAAC;oBACxC,OAAO;wBACL,OAAO,YAAY,KAAK;oBAC1B;gBACF;gBAEA,IAAI,CAAC,QAAQ,CAAC,KAAK,QAAQ,EAAE;oBAC3B,OAAO;gBACT;gBAEA,MAAM,kBAAkB,MAAM,IAAA,8IAAO,EACnC,YAAY,QAAQ,EACpB,KAAK,QAAQ;gBAGf,IAAI,CAAC,iBAAiB;oBACpB,OAAO;gBACT;gBAEA,OAAO;oBACL,IAAI,KAAK,EAAE;oBACX,OAAO,KAAK,KAAK;oBACjB,MAAM,KAAK,IAAI;oBACf,MAAM,KAAK,IAAI;gBACjB;YACF;QACF;KACD;IACD,WAAW;QACT,MAAM,KAAI,EAAE,KAAK,EAAE,IAAI,EAAE,OAAO,EAAE;YAChC,IAAI,MAAM;gBACR,OAAO;oBACL,GAAG,KAAK;oBACR,IAAI,KAAK,EAAE;oBACX,MAAM,KAAK,IAAI;gBACjB;YACF;YAEA,2CAA2C;YAC3C,IAAI,MAAM,EAAE,EAAE;gBACZ,MAAM,SAAS,MAAM,gIAAM,CAAC,IAAI,CAAC,UAAU,CAAC;oBAC1C,OAAO;wBAAE,IAAI,MAAM,EAAE;oBAAW;oBAChC,QAAQ;wBAAE,uBAAuB;wBAAM,MAAM;oBAAK;gBACpD;gBAEA,IAAI,QAAQ;oBACV,2DAA2D;oBAC3D,IAAI,OAAO,qBAAqB,EAAE;wBAChC,MAAM,gBAAgB,MAAM,GAAG,GAAG,MAAM,GAAG,GAAG,OAAO,GAAG,0BAA0B;wBAClF,MAAM,gBAAgB,IAAI,KAAK,OAAO,qBAAqB,EAAE,OAAO;wBAEpE,IAAI,gBAAgB,eAAe;4BACjC,+DAA+D;4BAC/D,OAAO;wBACT;oBACF;oBAEA,qCAAqC;oBACrC,MAAM,IAAI,GAAG,OAAO,IAAI;gBAC1B,OAAO;oBACL,wBAAwB;oBACxB,OAAO;gBACT;YACF;YAEA,OAAO;QACT;QACA,MAAM,SAAQ,EAAE,OAAO,EAAE,KAAK,EAAE;YAC9B,uCAAuC;YACvC,IAAI,CAAC,OAAO;gBACV,OAAO;YACT;YAEA,OAAO;gBACL,GAAG,OAAO;gBACV,MAAM;oBACJ,GAAG,QAAQ,IAAI;oBACf,IAAI,MAAM,EAAE;oBACZ,MAAM,MAAM,IAAI;gBAClB;YACF;QACF;IACF;AACF"}},
    {"offset": {"line": 246, "column": 0}, "map": {"version":3,"sources":["file:///C:/laragon/www/claude/ecommerce-platform/src/app/api/products/import/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport { getServerSession } from 'next-auth';\nimport { authOptions } from '@/lib/auth';\nimport { prisma } from '@/lib/prisma';\n\ninterface ProductRow {\n  Name?: string;\n  SKU?: string;\n  Description?: string;\n  Price?: string;\n  'Compare Price'?: string;\n  'Regular price'?: string;\n  'Sale price'?: string;\n  Stock?: string;\n  Category?: string;\n  Categories?: string;\n  Featured?: string;\n  Published?: string;\n  'Image URL'?: string;\n  Images?: string;\n}\n\nfunction parseCSV(text: string): ProductRow[] {\n  const lines = text.split('\\n').filter(line => line.trim());\n  if (lines.length === 0) return [];\n\n  const headers = lines[0].split(',').map(h => h.trim().replace(/^\"|\"$/g, ''));\n  const rows: ProductRow[] = [];\n\n  for (let i = 1; i < lines.length; i++) {\n    const line = lines[i];\n    const values: string[] = [];\n    let current = '';\n    let inQuotes = false;\n\n    for (let j = 0; j < line.length; j++) {\n      const char = line[j];\n      if (char === '\"') {\n        inQuotes = !inQuotes;\n      } else if (char === ',' && !inQuotes) {\n        values.push(current.trim());\n        current = '';\n      } else {\n        current += char;\n      }\n    }\n    values.push(current.trim());\n\n    const row: ProductRow = {};\n    headers.forEach((header, index) => {\n      row[header as keyof ProductRow] = values[index]?.replace(/^\"|\"$/g, '');\n    });\n    rows.push(row);\n  }\n\n  return rows;\n}\n\nfunction generateSlug(name: string): string {\n  return name\n    .toLowerCase()\n    .replace(/[^a-z0-9]+/g, '-')\n    .replace(/^-+|-+$/g, '');\n}\n\nfunction parseBoolean(value: string | undefined): boolean {\n  if (!value) return false;\n  const lower = value.toLowerCase();\n  return lower === 'true' || lower === '1' || lower === 'yes';\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    const session = await getServerSession(authOptions);\n\n    if (!session || session.user.role !== 'ADMIN') {\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\n    }\n\n    const formData = await request.formData();\n    const file = formData.get('file') as File;\n\n    if (!file) {\n      return NextResponse.json({ error: 'No file provided' }, { status: 400 });\n    }\n\n    const text = await file.text();\n    const rows = parseCSV(text);\n\n    if (rows.length === 0) {\n      return NextResponse.json({ error: 'CSV file is empty' }, { status: 400 });\n    }\n\n    let imported = 0;\n    let skipped = 0;\n    const errors: string[] = [];\n\n    for (const row of rows) {\n      try {\n        // Get product name (required)\n        const name = row.Name;\n        if (!name) {\n          errors.push('Row skipped: Missing product name');\n          skipped++;\n          continue;\n        }\n\n        // Get price (required)\n        const priceStr = row.Price || row['Regular price'];\n        if (!priceStr) {\n          errors.push(`Row skipped: \"${name}\" - Missing price`);\n          skipped++;\n          continue;\n        }\n\n        const price = parseFloat(priceStr.replace(/[^0-9.]/g, ''));\n        if (isNaN(price)) {\n          errors.push(`Row skipped: \"${name}\" - Invalid price`);\n          skipped++;\n          continue;\n        }\n\n        // Check if SKU already exists\n        const sku = row.SKU;\n        if (sku) {\n          const existing = await prisma.product.findUnique({\n            where: { sku },\n          });\n          if (existing) {\n            errors.push(`Skipped: \"${name}\" - SKU \"${sku}\" already exists`);\n            skipped++;\n            continue;\n          }\n        }\n\n        // Parse optional fields\n        const comparePriceStr = row['Compare Price'] || row['Sale price'];\n        const comparePrice = comparePriceStr\n          ? parseFloat(comparePriceStr.replace(/[^0-9.]/g, ''))\n          : null;\n\n        const stockStr = row.Stock;\n        const stock = stockStr ? parseInt(stockStr) : 0;\n\n        const description = row.Description || null;\n        const featured = parseBoolean(row.Featured);\n        const published = row.Published ? parseBoolean(row.Published) : true;\n\n        // Handle category\n        let categoryId: string | null = null;\n        const categoryName = row.Category || row.Categories;\n        if (categoryName) {\n          const categorySlug = generateSlug(categoryName);\n          let category = await prisma.category.findUnique({\n            where: { slug: categorySlug },\n          });\n\n          if (!category) {\n            // Create category if it doesn't exist\n            category = await prisma.category.create({\n              data: {\n                name: categoryName,\n                slug: categorySlug,\n              },\n            });\n          }\n\n          categoryId = category.id;\n        }\n\n        // Create product\n        const slug = generateSlug(name);\n        let finalSlug = slug;\n        let counter = 1;\n\n        // Ensure unique slug\n        while (\n          await prisma.product.findUnique({ where: { slug: finalSlug } })\n        ) {\n          finalSlug = `${slug}-${counter}`;\n          counter++;\n        }\n\n        const product = await prisma.product.create({\n          data: {\n            name,\n            slug: finalSlug,\n            description,\n            price,\n            comparePrice: comparePrice && !isNaN(comparePrice) ? comparePrice : null,\n            stock,\n            sku: sku || null,\n            featured,\n            published,\n            categoryId,\n          },\n        });\n\n        // Handle image if provided\n        const imageUrl = row['Image URL'] || row.Images;\n        if (imageUrl && product.id) {\n          try {\n            await prisma.productImage.create({\n              data: {\n                url: imageUrl,\n                alt: name,\n                position: 0,\n                productId: product.id,\n              },\n            });\n          } catch (imgError) {\n            // Image creation failed, but product is created\n            errors.push(`Warning: \"${name}\" - Failed to add image`);\n          }\n        }\n\n        imported++;\n      } catch (error) {\n        const name = row.Name || 'Unknown';\n        errors.push(`Error importing \"${name}\": ${error instanceof Error ? error.message : 'Unknown error'}`);\n        skipped++;\n      }\n    }\n\n    return NextResponse.json({\n      success: true,\n      message: `Import completed: ${imported} products imported, ${skipped} skipped`,\n      imported,\n      skipped,\n      errors: errors.length > 0 ? errors : undefined,\n    });\n  } catch (error) {\n    console.error('Import error:', error);\n    return NextResponse.json(\n      { error: 'Failed to import products' },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":"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"}}]
}