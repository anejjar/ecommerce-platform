
!function(){try{var e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[n]="3fad556b-4f7a-520d-b0ef-86bdc603616b")}catch(e){}}();
module.exports=[430014,e=>{"use strict";var t=e.i(747909),r=e.i(174017),a=e.i(996250),s=e.i(759756),n=e.i(561916),i=e.i(114444),o=e.i(837092),d=e.i(869741),l=e.i(316795),u=e.i(487718),c=e.i(995169),p=e.i(47587),h=e.i(666012),R=e.i(570101),m=e.i(626937),g=e.i(10372),E=e.i(193695);e.i(52474);var f=e.i(600220),y=e.i(89171),w=e.i(823667),S=e.i(79832),I=e.i(698043),v=e.i(635741),A=e.i(517350),x=e.i(286008);async function C(e){try{let t=await (0,w.getServerSession)(S.authOptions);if(!t?.user)return y.NextResponse.json({error:"Unauthorized"},{status:401});if(!["ADMIN","SUPERADMIN"].includes(t.user.role))return y.NextResponse.json({error:"Insufficient permissions"},{status:403});let r=e.nextUrl.searchParams,a=parseInt(r.get("page")||"1"),s=parseInt(r.get("limit")||"20"),n=r.get("type"),i=r.get("status"),o={};n&&(o.type=n),i&&(o.status=i);let[d,l]=await Promise.all([I.prisma.dataExport.findMany({where:o,include:{createdBy:{select:{id:!0,name:!0,email:!0}}},orderBy:{createdAt:"desc"},skip:(a-1)*s,take:s}),I.prisma.dataExport.count({where:o})]);return y.NextResponse.json({exports:d,total:l,page:a,limit:s,totalPages:Math.ceil(l/s)})}catch(e){return console.error("Error fetching exports:",e),y.NextResponse.json({error:"Internal server error"},{status:500})}}async function T(e){try{let t=await (0,w.getServerSession)(S.authOptions);if(!t?.user)return y.NextResponse.json({error:"Unauthorized"},{status:401});if(!["ADMIN","SUPERADMIN"].includes(t.user.role))return y.NextResponse.json({error:"Insufficient permissions"},{status:403});let{type:r,format:a="CSV",filters:s={}}=await e.json();if(!r||!["PRODUCTS","PRODUCT_IMAGES","PRODUCT_VARIANTS","ORDERS","CUSTOMERS","CATEGORIES","INVENTORY","BLOG_POSTS","PAGES","MEDIA_LIBRARY","REVIEWS","NEWSLETTER_SUBSCRIBERS","DISCOUNT_CODES"].includes(r))return y.NextResponse.json({error:"Invalid export type"},{status:400});if(!["CSV","JSON"].includes(a))return y.NextResponse.json({error:"Invalid format. Supported: CSV, JSON"},{status:400});let n=await I.prisma.dataExport.create({data:{type:r,format:a,status:"IN_PROGRESS",filters:JSON.stringify(s),createdById:t.user.id}});return await (0,A.logActivity)({userId:t.user.id,action:"CREATE",resource:"DATA_EXPORT",resourceId:n.id,details:`Started ${r} export in ${a} format`,ipAddress:(0,A.getClientIp)(e),userAgent:(0,A.getUserAgent)(e)}),setImmediate(async()=>{try{let e,t,i,o=[],d=0;switch(r){case"PRODUCTS":d=(o=await I.prisma.product.findMany({include:{category:!0,images:!0},where:s.categoryId?{categoryId:s.categoryId}:void 0})).length;break;case"ORDERS":let l={};s.status&&(l.status=s.status),s.startDate&&(l.createdAt={gte:new Date(s.startDate)}),s.endDate&&(l.createdAt={...l.createdAt,lte:new Date(s.endDate)}),d=(o=await I.prisma.order.findMany({where:l,include:{user:{select:{email:!0,name:!0}},items:!0}})).length;break;case"CUSTOMERS":d=(o=await I.prisma.user.findMany({where:{role:"CUSTOMER"},include:{orders:{select:{total:!0}}}})).length;break;case"CATEGORIES":d=(o=await I.prisma.category.findMany({include:{parent:!0,products:!0}})).length;break;case"INVENTORY":d=(o=await I.prisma.product.findMany({include:{category:!0,stockAlert:!0},where:s.lowStock?{stock:{lt:10}}:void 0})).length;break;case"PRODUCT_IMAGES":let u={};s.productId&&(u.productId=s.productId),d=(o=await I.prisma.productImage.findMany({where:u,include:{product:{select:{name:!0,sku:!0}}},orderBy:[{productId:"asc"},{position:"asc"}]})).length;break;case"PRODUCT_VARIANTS":let c={};s.productId&&(c.productId=s.productId),d=(o=await I.prisma.productVariant.findMany({where:c,include:{product:{select:{name:!0,sku:!0}}},orderBy:{productId:"asc"}})).length;break;case"BLOG_POSTS":let p={};s.status&&(p.status=s.status),s.categoryId&&(p.categoryId=s.categoryId),s.authorId&&(p.authorId=s.authorId),d=(o=await I.prisma.blogPost.findMany({where:p,include:{category:{select:{name:!0,slug:!0}},author:{select:{name:!0,email:!0}}},orderBy:{createdAt:"desc"}})).length;break;case"PAGES":let h={};s.status&&(h.status=s.status),s.template&&(h.template=s.template),d=(o=await I.prisma.page.findMany({where:h,include:{parent:{select:{title:!0,slug:!0}}},orderBy:{createdAt:"desc"}})).length;break;case"MEDIA_LIBRARY":let R={};s.mimeType&&(R.mimeType={contains:s.mimeType}),s.uploadedById&&(R.uploadedById=s.uploadedById),d=(o=await I.prisma.file.findMany({where:R,include:{uploadedBy:{select:{name:!0,email:!0}}},orderBy:{uploadedAt:"desc"}})).length;break;case"REVIEWS":let m={};s.productId&&(m.productId=s.productId),s.rating&&(m.rating=parseInt(s.rating)),void 0!==s.approved&&(m.approved="true"===s.approved),void 0!==s.verified&&(m.verified="true"===s.verified),d=(o=await I.prisma.review.findMany({where:m,include:{product:{select:{name:!0,sku:!0}},user:{select:{name:!0,email:!0}}},orderBy:{createdAt:"desc"}})).length;break;case"NEWSLETTER_SUBSCRIBERS":let g={};void 0!==s.active&&(g.active="true"===s.active),s.source&&(g.source=s.source),d=(o=await I.prisma.newsletterSubscriber.findMany({where:g,orderBy:{subscribedAt:"desc"}})).length;break;case"DISCOUNT_CODES":let E={};void 0!==s.active&&(E.active="true"===s.active),s.type&&(E.type=s.type),d=(o=await I.prisma.discountCode.findMany({where:E,orderBy:{createdAt:"desc"}})).length}if("CSV"===a){let a=(0,x.getExportColumns)(r);e=(0,x.convertToCSV)(o,a),t="text/csv",i="csv"}else e=JSON.stringify(o,null,2),t="application/json",i="json";let f=`export-${r.toLowerCase()}-${Date.now()}.${i}`,y=Buffer.byteLength(e,"utf8"),w=await v.default.uploader.upload(`data:${t};base64,${Buffer.from(e).toString("base64")}`,{folder:"ecommerce/exports",resource_type:"raw",public_id:`export-${n.id}`,format:i});await I.prisma.dataExport.update({where:{id:n.id},data:{status:"COMPLETED",filename:f,fileUrl:w.secure_url,fileSize:y,recordCount:d,completedAt:new Date,expiresAt:new Date(Date.now()+6048e5)}}),console.log(`Export ${n.id} completed successfully`)}catch(e){console.error(`Error generating export ${n.id}:`,e),await I.prisma.dataExport.update({where:{id:n.id},data:{status:"FAILED",errorMessage:e instanceof Error?e.message:"Unknown error"}})}}),y.NextResponse.json({export:{id:n.id,status:n.status,message:"Export started. Check status at /api/admin/export/"+n.id}},{status:201})}catch(e){return console.error("Error creating export:",e),y.NextResponse.json({error:"Internal server error"},{status:500})}}e.s(["GET",()=>C,"POST",()=>T],629895);var O=e.i(629895);let N=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/admin/export/route",pathname:"/api/admin/export",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/admin/export/route.ts",nextConfigOutput:"",userland:O}),{workAsyncStorage:D,workUnitAsyncStorage:M,serverHooks:P}=N;function b(){return(0,a.patchFetch)({workAsyncStorage:D,workUnitAsyncStorage:M})}async function U(e,t,a){N.isDev&&(0,s.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let y="/api/admin/export/route";y=y.replace(/\/index$/,"")||"/";let w=await N.prepare(e,t,{srcPage:y,multiZoneDraftMode:!1});if(!w)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:S,params:I,nextConfig:v,parsedUrl:A,isDraftMode:x,prerenderManifest:C,routerServerContext:T,isOnDemandRevalidate:O,revalidateOnlyGenerated:D,resolvedPathname:M,clientReferenceManifest:P,serverActionsManifest:b}=w,U=(0,d.normalizeAppPath)(y),_=!!(C.dynamicRoutes[U]||C.routes[M]),k=async()=>((null==T?void 0:T.render404)?await T.render404(e,t,A,!1):t.end("This page could not be found"),null);if(_&&!x){let e=!!C.routes[M],t=C.dynamicRoutes[U];if(t&&!1===t.fallback&&!e){if(v.experimental.adapterPath)return await k();throw new E.NoFallbackError}}let B=null;!_||N.isDev||x||(B="/index"===(B=M)?"/":B);let j=!0===N.isDev||!_,$=_&&!j;b&&P&&(0,i.setReferenceManifestsSingleton)({page:y,clientReferenceManifest:P,serverActionsManifest:b,serverModuleMap:(0,o.createServerModuleMap)({serverActionsManifest:b})});let H=e.method||"GET",L=(0,n.getTracer)(),V=L.getActiveScopeSpan(),q={params:I,prerenderManifest:C,renderOpts:{experimental:{authInterrupts:!!v.experimental.authInterrupts},cacheComponents:!!v.cacheComponents,supportsDynamicResponse:j,incrementalCache:(0,s.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:v.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a)=>N.onRequestError(e,t,a,T)},sharedContext:{buildId:S}},G=new l.NodeNextRequest(e),F=new l.NodeNextResponse(t),K=u.NextRequestAdapter.fromNodeNextRequest(G,(0,u.signalFromNodeResponse)(t));try{let i=async e=>N.handle(K,q).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=L.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==c.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let t=`${H} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${H} ${y}`)}),o=!!(0,s.getRequestMeta)(e,"minimalMode"),d=async s=>{var n,d;let l=async({previousCacheEntry:r})=>{try{if(!o&&O&&D&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await i(s);e.fetchMetrics=q.renderOpts.fetchMetrics;let d=q.renderOpts.pendingWaitUntil;d&&a.waitUntil&&(a.waitUntil(d),d=void 0);let l=q.renderOpts.collectedTags;if(!_)return await (0,h.sendResponse)(G,F,n,q.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,R.toNodeOutgoingHttpHeaders)(n.headers);l&&(t[g.NEXT_CACHE_TAGS_HEADER]=l),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==q.renderOpts.collectedRevalidate&&!(q.renderOpts.collectedRevalidate>=g.INFINITE_CACHE)&&q.renderOpts.collectedRevalidate,a=void 0===q.renderOpts.collectedExpire||q.renderOpts.collectedExpire>=g.INFINITE_CACHE?void 0:q.renderOpts.collectedExpire;return{value:{kind:f.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==r?void 0:r.isStale)&&await N.onRequestError(e,t,{routerKind:"App Router",routePath:y,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:$,isOnDemandRevalidate:O})},T),t}},u=await N.handleResponse({req:e,nextConfig:v,cacheKey:B,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:C,isRoutePPREnabled:!1,isOnDemandRevalidate:O,revalidateOnlyGenerated:D,responseGenerator:l,waitUntil:a.waitUntil,isMinimalMode:o});if(!_)return null;if((null==u||null==(n=u.value)?void 0:n.kind)!==f.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(d=u.value)?void 0:d.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",O?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),x&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let c=(0,R.fromNodeOutgoingHttpHeaders)(u.value.headers);return o&&_||c.delete(g.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||c.get("Cache-Control")||c.set("Cache-Control",(0,m.getCacheControlHeader)(u.cacheControl)),await (0,h.sendResponse)(G,F,new Response(u.value.body,{headers:c,status:u.value.status||200})),null};V?await d(V):await L.withPropagatedContext(e.headers,()=>L.trace(c.BaseServerSpan.handleRequest,{spanName:`${H} ${y}`,kind:n.SpanKind.SERVER,attributes:{"http.method":H,"http.target":e.url}},d))}catch(t){if(t instanceof E.NoFallbackError||await N.onRequestError(e,t,{routerKind:"App Router",routePath:U,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:$,isOnDemandRevalidate:O})}),_)throw t;return await (0,h.sendResponse)(G,F,new Response(null,{status:500})),null}}e.s(["handler",()=>U,"patchFetch",()=>b,"routeModule",()=>N,"serverHooks",()=>P,"workAsyncStorage",()=>D,"workUnitAsyncStorage",()=>M],430014)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_b3109f81.js.map
//# debugId=3fad556b-4f7a-520d-b0ef-86bdc603616b
