
!function(){try{var e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[n]="3c008208-c9ab-5e3f-95f6-b5d6ee566dfb")}catch(e){}}();
module.exports=[670797,e=>{"use strict";var t=e.i(747909),r=e.i(174017),a=e.i(996250),i=e.i(759756),n=e.i(561916),o=e.i(114444),s=e.i(837092),d=e.i(869741),l=e.i(316795),u=e.i(487718),c=e.i(995169),p=e.i(47587),m=e.i(666012),h=e.i(570101),f=e.i(626937),w=e.i(10372),g=e.i(193695);e.i(52474);var v=e.i(600220),R=e.i(89171),y=e.i(757660),N=e.i(79832),E=e.i(698043),I=e.i(492749),S=e.i(848782),A=e.i(449632);async function x(){let e=new Date,t=e.getFullYear(),r=String(e.getMonth()+1).padStart(2,"0"),a=String(e.getDate()).padStart(2,"0"),i=new Date(e.getFullYear(),e.getMonth(),e.getDate()),n=new Date(e.getFullYear(),e.getMonth(),e.getDate()+1),o=String(await E.prisma.order.count({where:{createdAt:{gte:i,lt:n}}})+1).padStart(4,"0");return`ORD-${t}${r}${a}-${o}`}async function b(e){try{let t,r=await (0,y.getServerSession)(N.authOptions),a=await e.json(),{items:i,shippingAddress:n,customerInfo:o,isGuest:s,createAccount:d,password:l,orderNotes:u}=a;if(!i||0===i.length)return R.NextResponse.json({error:"Cart is empty"},{status:400});if(!n||!n.address1||!n.city)return R.NextResponse.json({error:"Complete shipping address is required"},{status:400});if(!o?.email)return R.NextResponse.json({error:"Email is required"},{status:400});if(r&&r.user){if(!(t=await E.prisma.user.findUnique({where:{email:r.user.email}})))return R.NextResponse.json({error:"User not found. Please sign in again."},{status:401})}else if(!s)return R.NextResponse.json({error:"Unauthorized"},{status:401});else if(d){if(!l||l.length<6)return R.NextResponse.json({error:"Password must be at least 6 characters"},{status:400});if(await E.prisma.user.findUnique({where:{email:o.email}}))return R.NextResponse.json({error:"Email already exists. Please sign in."},{status:400});let e=await A.default.hash(l,10);t=await E.prisma.user.create({data:{email:o.email,password:e,name:`${o.firstName} ${o.lastName}`.trim(),role:"CUSTOMER"}});try{await (0,I.sendEmail)({to:t.email,subject:"Welcome to Our Store!",html:(0,S.welcomeEmail)(t.name||t.email)})}catch(e){console.error("Failed to send welcome email:",e)}}else t=null;let c=0,p=[];for(let e of i){let t;if(e.variantId){let r=await E.prisma.productVariant.findUnique({where:{id:e.variantId},include:{product:!0}});if(!r)return console.error("Checkout Error: Variant not found",{variantId:e.variantId,productId:e.productId,item:e,timestamp:new Date().toISOString()}),R.NextResponse.json({error:`Product variant not available: Variant ID ${e.variantId} not found`},{status:400});if(!r.product.published)return console.error("Checkout Error: Variant product not published",{variantId:e.variantId,productId:e.productId,productName:r.product.name,published:r.product.published,item:e,timestamp:new Date().toISOString()}),R.NextResponse.json({error:`Product variant not available: ${r.product.name} is no longer available`},{status:400});if(t=r.price?Number(r.price):Number(r.product.price),r.stock<e.quantity)return R.NextResponse.json({error:"Insufficient stock for variant"},{status:400})}else{let r=await E.prisma.product.findUnique({where:{id:e.productId}});if(!r)return console.error("Checkout Error: Product not found",{productId:e.productId,item:e,timestamp:new Date().toISOString()}),R.NextResponse.json({error:`Product not available: Product ID ${e.productId} not found`},{status:400});if(!r.published)return console.error("Checkout Error: Product not published",{productId:e.productId,productName:r.name,published:r.published,item:e,timestamp:new Date().toISOString()}),R.NextResponse.json({error:`Product not available: ${r.name} is no longer available`},{status:400});let a=new Date,i=await E.prisma.flashSaleProduct.findFirst({where:{productId:e.productId,flashSale:{status:"ACTIVE",isActive:!0,startDate:{lte:a},endDate:{gt:a}},OR:[{maxQuantity:null},{soldQuantity:{lt:E.prisma.flashSaleProduct.fields.maxQuantity}}]},orderBy:{flashSale:{priority:"desc"}}});if(t=i?Number(i.salePrice):Number(r.price),r.stock<e.quantity)return R.NextResponse.json({error:`Insufficient stock for ${r.name}`},{status:400});if(i&&null!==i.maxQuantity){let t=i.maxQuantity-i.soldQuantity;if(t<e.quantity)return R.NextResponse.json({error:`Only ${t} available at flash sale price for ${r.name}`},{status:400})}}let r=t*e.quantity;c+=r,p.push({productId:e.productId,variantId:e.variantId||null,price:t,quantity:e.quantity,total:r})}let m=.1*c,h=c>50?0:10,f=c+m+h,w=0,g=null;if(a.discountCodeId){let e=await E.prisma.discountCode.findUnique({where:{id:a.discountCodeId}});if(e&&e.isActive){let t=new Date,r=e.startDate<=t&&(!e.endDate||e.endDate>=t),a=!e.maxUses||e.usedCount<e.maxUses,i=!e.minOrderAmount||c>=Number(e.minOrderAmount);r&&a&&i&&(w="PERCENTAGE"===e.type?c*Number(e.value)/100:Number(e.value),w=Math.min(w,f),f-=w,g=e.id,await E.prisma.discountCode.update({where:{id:e.id},data:{usedCount:{increment:1}}}))}}let v=await E.prisma.address.create({data:{firstName:o.firstName||"",lastName:o.lastName||"",company:n.company||null,address1:n.address1,address2:n.address2||null,city:n.city,state:n.state||null,postalCode:n.postalCode||"00000",country:n.country||"Morocco",phone:o.phone||null,userId:t?.id||null}}),b=await x(),C=await E.prisma.order.create({data:{orderNumber:b,status:"PENDING",paymentStatus:"PENDING",subtotal:c,tax:m,shipping:h,total:f,discountCodeId:g,discountAmount:w,notes:u||null,userId:t?.id||null,isGuest:!t||s,guestEmail:t?null:o.email,shippingAddressId:v.id,items:{create:p}},include:{items:{include:{product:!0,variant:!0}},user:!0,shippingAddress:!0}});for(let e of[])await E.prisma.flashSaleProduct.update({where:{id:e.flashSaleProductId},data:{soldQuantity:{increment:e.quantity}}});for(let e of i)e.variantId?await E.prisma.$transaction([E.prisma.productVariant.update({where:{id:e.variantId},data:{stock:{decrement:e.quantity}}}),E.prisma.product.update({where:{id:e.productId},data:{stock:{decrement:e.quantity}}})]):await E.prisma.product.update({where:{id:e.productId},data:{stock:{decrement:e.quantity}}});try{let e=i.map(e=>e.productId),t=(await E.prisma.product.findMany({where:{id:{in:e},stockAlert:{isNot:null}},include:{stockAlert:!0}})).filter(e=>{if(!e.stockAlert)return!1;let t=e.stockAlert.threshold;return e.stock<=t&&!e.stockAlert.notified});if(t.length>0){let e=process.env.ADMIN_EMAIL;e&&(await (0,I.sendEmail)({to:e,subject:"Low Stock Alert",html:(0,S.lowStockAlertEmail)(t.map(e=>({name:e.name,sku:e.sku,stock:e.stock,threshold:e.stockAlert.threshold})))}),await E.prisma.stockAlert.updateMany({where:{productId:{in:t.map(e=>e.id)}},data:{notified:!0}}))}}catch(e){console.error("Failed to check/send stock alerts:",e)}let k=t?.email||o.email,P=t?.name||`${o.firstName} ${o.lastName}`.trim();try{await (0,I.sendEmail)({to:k,subject:`Order Confirmation - ${b}`,html:(0,S.orderConfirmationEmail)({orderNumber:C.orderNumber,total:C.total.toString(),subtotal:C.subtotal.toString(),tax:C.tax.toString(),shipping:C.shipping.toString(),discountAmount:C.discountAmount.toString(),status:C.status,items:C.items.map(e=>({product:{name:e.product.name},quantity:e.quantity,price:e.price.toString(),total:e.total.toString()})),shippingAddress:C.shippingAddress||void 0},P||k)})}catch(e){console.error("Failed to send order confirmation email:",e)}try{let e=process.env.ADMIN_EMAIL;e&&await (0,I.sendEmail)({to:e,subject:`New Order Received - ${b}`,html:(0,S.adminNewOrderEmail)({orderNumber:C.orderNumber,total:C.total.toString(),subtotal:C.subtotal.toString(),tax:C.tax.toString(),shipping:C.shipping.toString(),discountAmount:C.discountAmount.toString(),status:C.status,items:C.items.map(e=>({product:{name:e.product.name},quantity:e.quantity,price:e.price.toString(),total:e.total.toString()})),shippingAddress:C.shippingAddress||void 0},k)})}catch(e){console.error("Failed to send admin notification email:",e)}return R.NextResponse.json(C)}catch(e){return console.error("Checkout error:",e),R.NextResponse.json({error:"Failed to process checkout"},{status:500})}}e.s(["POST",()=>b],95519);var C=e.i(95519);let k=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/checkout/route",pathname:"/api/checkout",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/checkout/route.ts",nextConfigOutput:"",userland:C}),{workAsyncStorage:P,workUnitAsyncStorage:D,serverHooks:O}=k;function q(){return(0,a.patchFetch)({workAsyncStorage:P,workUnitAsyncStorage:D})}async function j(e,t,a){k.isDev&&(0,i.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let R="/api/checkout/route";R=R.replace(/\/index$/,"")||"/";let y=await k.prepare(e,t,{srcPage:R,multiZoneDraftMode:!1});if(!y)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:N,params:E,nextConfig:I,parsedUrl:S,isDraftMode:A,prerenderManifest:x,routerServerContext:b,isOnDemandRevalidate:C,revalidateOnlyGenerated:P,resolvedPathname:D,clientReferenceManifest:O,serverActionsManifest:q}=y,j=(0,d.normalizeAppPath)(R),M=!!(x.dynamicRoutes[j]||x.routes[D]),T=async()=>((null==b?void 0:b.render404)?await b.render404(e,t,S,!1):t.end("This page could not be found"),null);if(M&&!A){let e=!!x.routes[D],t=x.dynamicRoutes[j];if(t&&!1===t.fallback&&!e){if(I.experimental.adapterPath)return await T();throw new g.NoFallbackError}}let $=null;!M||k.isDev||A||($="/index"===($=D)?"/":$);let U=!0===k.isDev||!M,_=M&&!U;q&&O&&(0,o.setReferenceManifestsSingleton)({page:R,clientReferenceManifest:O,serverActionsManifest:q,serverModuleMap:(0,s.createServerModuleMap)({serverActionsManifest:q})});let F=e.method||"GET",H=(0,n.getTracer)(),V=H.getActiveScopeSpan(),K={params:E,prerenderManifest:x,renderOpts:{experimental:{authInterrupts:!!I.experimental.authInterrupts},cacheComponents:!!I.cacheComponents,supportsDynamicResponse:U,incrementalCache:(0,i.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:I.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a)=>k.onRequestError(e,t,a,b)},sharedContext:{buildId:N}},L=new l.NodeNextRequest(e),G=new l.NodeNextResponse(t),Q=u.NextRequestAdapter.fromNodeNextRequest(L,(0,u.signalFromNodeResponse)(t));try{let o=async e=>k.handle(Q,K).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=H.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==c.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let t=`${F} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${F} ${R}`)}),s=!!(0,i.getRequestMeta)(e,"minimalMode"),d=async i=>{var n,d;let l=async({previousCacheEntry:r})=>{try{if(!s&&C&&P&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await o(i);e.fetchMetrics=K.renderOpts.fetchMetrics;let d=K.renderOpts.pendingWaitUntil;d&&a.waitUntil&&(a.waitUntil(d),d=void 0);let l=K.renderOpts.collectedTags;if(!M)return await (0,m.sendResponse)(L,G,n,K.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,h.toNodeOutgoingHttpHeaders)(n.headers);l&&(t[w.NEXT_CACHE_TAGS_HEADER]=l),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==K.renderOpts.collectedRevalidate&&!(K.renderOpts.collectedRevalidate>=w.INFINITE_CACHE)&&K.renderOpts.collectedRevalidate,a=void 0===K.renderOpts.collectedExpire||K.renderOpts.collectedExpire>=w.INFINITE_CACHE?void 0:K.renderOpts.collectedExpire;return{value:{kind:v.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==r?void 0:r.isStale)&&await k.onRequestError(e,t,{routerKind:"App Router",routePath:R,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:_,isOnDemandRevalidate:C})},b),t}},u=await k.handleResponse({req:e,nextConfig:I,cacheKey:$,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:x,isRoutePPREnabled:!1,isOnDemandRevalidate:C,revalidateOnlyGenerated:P,responseGenerator:l,waitUntil:a.waitUntil,isMinimalMode:s});if(!M)return null;if((null==u||null==(n=u.value)?void 0:n.kind)!==v.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(d=u.value)?void 0:d.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",C?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),A&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let c=(0,h.fromNodeOutgoingHttpHeaders)(u.value.headers);return s&&M||c.delete(w.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||c.get("Cache-Control")||c.set("Cache-Control",(0,f.getCacheControlHeader)(u.cacheControl)),await (0,m.sendResponse)(L,G,new Response(u.value.body,{headers:c,status:u.value.status||200})),null};V?await d(V):await H.withPropagatedContext(e.headers,()=>H.trace(c.BaseServerSpan.handleRequest,{spanName:`${F} ${R}`,kind:n.SpanKind.SERVER,attributes:{"http.method":F,"http.target":e.url}},d))}catch(t){if(t instanceof g.NoFallbackError||await k.onRequestError(e,t,{routerKind:"App Router",routePath:j,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:_,isOnDemandRevalidate:C})}),M)throw t;return await (0,m.sendResponse)(L,G,new Response(null,{status:500})),null}}e.s(["handler",()=>j,"patchFetch",()=>q,"routeModule",()=>k,"serverHooks",()=>O,"workAsyncStorage",()=>P,"workUnitAsyncStorage",()=>D],670797)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_9909f5b5.js.map
//# debugId=3c008208-c9ab-5e3f-95f6-b5d6ee566dfb
