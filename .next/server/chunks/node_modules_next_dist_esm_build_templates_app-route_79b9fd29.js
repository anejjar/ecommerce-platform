
!function(){try{var e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[n]="f9af62a3-5bf8-5757-b744-b8e525600c32")}catch(e){}}();
module.exports=[545114,e=>{"use strict";var t=e.i(747909),a=e.i(174017),n=e.i(996250),r=e.i(759756),o=e.i(561916),i=e.i(114444),s=e.i(837092),l=e.i(869741),d=e.i(316795),p=e.i(487718),u=e.i(995169),c=e.i(47587),m=e.i(666012),h=e.i(570101),y=e.i(626937),f=e.i(10372),v=e.i(193695);e.i(52474);var g=e.i(600220),b=e.i(89171),x=e.i(698043),w=e.i(582477),E=e.i(492749);async function R(e){let t=`COMEBACK${Math.random().toString(36).substring(2,8).toUpperCase()}`;return await x.prisma.discountCode.create({data:{code:t,type:"PERCENTAGE",value:10,minOrderAmount:null,maxUses:1,startDate:new Date,endDate:new Date(Date.now()+6048e5),isActive:!0}}),t}async function C(e){try{if(e.headers.get("authorization")!==`Bearer ${process.env.CRON_SECRET}`)return b.NextResponse.json({error:"Unauthorized"},{status:401});if(!await (0,w.isFeatureEnabled)("abandoned_cart"))return b.NextResponse.json({error:"Feature not available"},{status:404});let a=new Date,n=new Date(a.getTime()-36e5),r=new Date(a.getTime()-864e5),o=new Date(a.getTime()-2592e5),i=new Date(a.getTime()-2592e6),s=0,l=process.env.NEXT_PUBLIC_URL||"http://localhost:3000";for(let e of(await x.prisma.abandonedCart.findMany({where:{status:"ABANDONED",abandonedAt:{lte:n,gte:r},emails:{none:{emailType:"FIRST_REMINDER"}}},include:{user:!0}}))){let a=JSON.parse(e.cartSnapshot).map(e=>({productId:e.productId,name:e.name||"Unknown Product",quantity:e.quantity,price:e.price})),n=e.user?.name||e.guestName||null,r=e.user?.email||e.guestEmail;if(!r)continue;let o=`${l}/cart/recover/${e.recoveryToken}`;try{var t;await (0,E.sendEmail)({to:r,subject:"You Left Something Behind! üõí",html:(t=e.totalValue.toString(),`
    <h2>You Left Something Behind! üõí</h2>
    <p>Hi ${n||"there"},</p>
    <p>We noticed you left some items in your cart. Don't worry, we've saved them for you!</p>

    <div class="order-details">
      <h3>Your Cart Items</h3>

      ${a.map(e=>`
        <div class="order-item">
          <div>
            <strong>${e.name}</strong><br>
            <span style="color: #6b7280;">Quantity: ${e.quantity}</span>
          </div>
          <div style="text-align: right;">
            <strong>$${(e.price*e.quantity).toFixed(2)}</strong><br>
            <span style="color: #6b7280; font-size: 14px;">$${e.price.toFixed(2)} each</span>
          </div>
        </div>
      `).join("")}

      <div class="order-total">
        <div style="display: flex; justify-content: space-between; font-size: 18px; font-weight: bold;">
          <span>Total:</span>
          <span>$${t}</span>
        </div>
      </div>
    </div>

    <a href="${o}" class="button">
      Complete Your Purchase
    </a>

    <p>These items are popular and might sell out soon. Complete your purchase now to secure your items!</p>

    <p style="color: #6b7280; font-size: 14px; margin-top: 30px;">
      This is a one-time reminder. Your cart will remain saved for 30 days.
    </p>
  `)}),await x.prisma.abandonedCartEmail.create({data:{abandonedCartId:e.id,emailType:"FIRST_REMINDER"}}),s++}catch(t){console.error(`Failed to send first reminder for cart ${e.id}:`,t)}}for(let e of(await x.prisma.abandonedCart.findMany({where:{status:"ABANDONED",abandonedAt:{lte:r,gte:o},emails:{none:{emailType:"SECOND_REMINDER"}}},include:{user:!0}}))){let t=JSON.parse(e.cartSnapshot).map(e=>({productId:e.productId,name:e.name||"Unknown Product",quantity:e.quantity,price:e.price})),a=e.user?.name||e.guestName||null,n=e.user?.email||e.guestEmail;if(!n)continue;let r=e.discountCode;r||(r=await R(e.id),await x.prisma.abandonedCart.update({where:{id:e.id},data:{discountCode:r}}));let o=`${l}/cart/recover/${e.recoveryToken}`;try{await (0,E.sendEmail)({to:n,subject:"Still Thinking? Here's 10% Off! üéÅ",html:function(e,t,a,n,r){let o=r?`
    <div style="background-color: #dcfce7; border: 2px solid #22c55e; border-radius: 8px; padding: 20px; margin: 20px 0; text-align: center;">
      <p style="margin: 0 0 10px 0; font-size: 14px; color: #15803d;">Your Exclusive Discount Code:</p>
      <p style="margin: 0; font-size: 24px; font-weight: bold; color: #15803d; letter-spacing: 2px;">${r}</p>
      <p style="margin: 10px 0 0 0; font-size: 14px; color: #15803d;">Save 10% on your order!</p>
    </div>
  `:"",i=r?`
    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
      <span>Subtotal:</span>
      <span>$${a}</span>
    </div>
    <div style="display: flex; justify-content: space-between; color: #22c55e; margin-bottom: 5px;">
      <span>Discount (10%):</span>
      <span>-$${(.1*parseFloat(a)).toFixed(2)}</span>
    </div>
    <div style="display: flex; justify-content: space-between; font-size: 18px; font-weight: bold; padding-top: 10px; border-top: 2px solid #e5e7eb;">
      <span>New Total:</span>
      <span>$${(.9*parseFloat(a)).toFixed(2)}</span>
    </div>
  `:"";return`
    <h2>Still Thinking About It? Here's 10% Off! üéÅ</h2>
    <p>Hi ${e||"there"},</p>
    <p>We understand sometimes you need a little more time to decide. That's why we'd like to offer you a special discount!</p>

    ${o}

    <div class="order-details">
      <h3>Your Saved Items</h3>

      ${t.map(e=>`
        <div class="order-item">
          <div>
            <strong>${e.name}</strong><br>
            <span style="color: #6b7280;">Quantity: ${e.quantity}</span>
          </div>
          <div style="text-align: right;">
            <strong>$${(e.price*e.quantity).toFixed(2)}</strong>
          </div>
        </div>
      `).join("")}

      <div class="order-total">
        ${i}
      </div>
    </div>

    <a href="${n}" class="button">
      Claim Your Discount & Checkout
    </a>

    <p>This exclusive offer is only available for a limited time. Don't miss out!</p>
  `}(a,t,e.totalValue.toString(),o,r)}),await x.prisma.abandonedCartEmail.create({data:{abandonedCartId:e.id,emailType:"SECOND_REMINDER"}}),s++}catch(t){console.error(`Failed to send second reminder for cart ${e.id}:`,t)}}for(let e of(await x.prisma.abandonedCart.findMany({where:{status:"ABANDONED",abandonedAt:{lte:o,gte:i},emails:{none:{emailType:"FINAL_REMINDER"}}},include:{user:!0}}))){let t=JSON.parse(e.cartSnapshot).map(e=>({productId:e.productId,name:e.name||"Unknown Product",quantity:e.quantity,price:e.price})),a=e.user?.name||e.guestName||null,n=e.user?.email||e.guestEmail;if(!n)continue;let r=`${l}/cart/recover/${e.recoveryToken}`;try{await (0,E.sendEmail)({to:n,subject:"Last Chance! Your Cart is Waiting ‚è∞",html:function(e,t,a,n,r){let o=r?`
    <div style="background-color: #fef3c7; border: 2px solid #f59e0b; border-radius: 8px; padding: 20px; margin: 20px 0; text-align: center;">
      <p style="margin: 0 0 10px 0; font-size: 14px; color: #b45309;">‚ö° Your discount is still active!</p>
      <p style="margin: 0; font-size: 24px; font-weight: bold; color: #b45309; letter-spacing: 2px;">${r}</p>
      <p style="margin: 10px 0 0 0; font-size: 14px; color: #b45309;">Save 10% - Expires in 24 hours</p>
    </div>
  `:"",i=r?`
    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
      <span>Original Total:</span>
      <span style="text-decoration: line-through; color: #9ca3af;">$${a}</span>
    </div>
    <div style="display: flex; justify-content: space-between; font-size: 18px; font-weight: bold; color: #22c55e;">
      <span>Your Price:</span>
      <span>$${(.9*parseFloat(a)).toFixed(2)}</span>
    </div>
  `:`
    <div style="display: flex; justify-content: space-between; font-size: 18px; font-weight: bold;">
      <span>Total:</span>
      <span>$${a}</span>
    </div>
  `;return`
    <h2>Last Chance! Your Cart is Waiting ‚è∞</h2>
    <p>Hi ${e||"there"},</p>
    <p>This is our final reminder about the items in your cart. We really don't want you to miss out!</p>

    ${o}

    <div class="order-details">
      <h3>Items You're About to Miss</h3>

      ${t.map(e=>`
        <div class="order-item">
          <div>
            <strong>${e.name}</strong><br>
            <span style="color: #6b7280;">Quantity: ${e.quantity}</span>
          </div>
          <div style="text-align: right;">
            <strong>$${(e.price*e.quantity).toFixed(2)}</strong>
          </div>
        </div>
      `).join("")}

      <div class="order-total">
        ${i}
      </div>
    </div>

    <a href="${n}" class="button" style="background-color: #dc2626;">
      Complete Purchase Now
    </a>

    <p><strong>Why customers love shopping with us:</strong></p>
    <ul style="color: #6b7280; padding-left: 20px;">
      <li>Free shipping on orders over $50</li>
      <li>30-day money-back guarantee</li>
      <li>Secure checkout</li>
      <li>24/7 customer support</li>
    </ul>

    <p style="color: #6b7280; font-size: 14px; margin-top: 30px;">
      We won't send any more reminders about this cart. Your saved items will expire in 27 days.
    </p>
  `}(a,t,e.totalValue.toString(),r,e.discountCode||void 0)}),await x.prisma.abandonedCartEmail.create({data:{abandonedCartId:e.id,emailType:"FINAL_REMINDER"}}),s++}catch(t){console.error(`Failed to send final reminder for cart ${e.id}:`,t)}}return await x.prisma.abandonedCart.updateMany({where:{status:"ABANDONED",abandonedAt:{lt:i}},data:{status:"EXPIRED"}}),b.NextResponse.json({success:!0,emailsSent:s,timestamp:a.toISOString()})}catch(e){return console.error("Error processing abandoned carts:",e),b.NextResponse.json({error:"Failed to process abandoned carts"},{status:500})}}e.s(["GET",()=>C],57534);var $=e.i(57534);let N=new t.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/cron/abandoned-carts/route",pathname:"/api/cron/abandoned-carts",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/cron/abandoned-carts/route.ts",nextConfigOutput:"",userland:$}),{workAsyncStorage:T,workUnitAsyncStorage:A,serverHooks:S}=N;function D(){return(0,n.patchFetch)({workAsyncStorage:T,workUnitAsyncStorage:A})}async function I(e,t,n){N.isDev&&(0,r.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let b="/api/cron/abandoned-carts/route";b=b.replace(/\/index$/,"")||"/";let x=await N.prepare(e,t,{srcPage:b,multiZoneDraftMode:!1});if(!x)return t.statusCode=400,t.end("Bad Request"),null==n.waitUntil||n.waitUntil.call(n,Promise.resolve()),null;let{buildId:w,params:E,nextConfig:R,parsedUrl:C,isDraftMode:$,prerenderManifest:T,routerServerContext:A,isOnDemandRevalidate:S,revalidateOnlyGenerated:D,resolvedPathname:I,clientReferenceManifest:O,serverActionsManifest:P}=x,_=(0,l.normalizeAppPath)(b),F=!!(T.dynamicRoutes[_]||T.routes[I]),M=async()=>((null==A?void 0:A.render404)?await A.render404(e,t,C,!1):t.end("This page could not be found"),null);if(F&&!$){let e=!!T.routes[I],t=T.dynamicRoutes[_];if(t&&!1===t.fallback&&!e){if(R.experimental.adapterPath)return await M();throw new v.NoFallbackError}}let k=null;!F||N.isDev||$||(k="/index"===(k=I)?"/":k);let q=!0===N.isDev||!F,j=F&&!q;P&&O&&(0,i.setReferenceManifestsSingleton)({page:b,clientReferenceManifest:O,serverActionsManifest:P,serverModuleMap:(0,s.createServerModuleMap)({serverActionsManifest:P})});let U=e.method||"GET",H=(0,o.getTracer)(),z=H.getActiveScopeSpan(),B={params:E,prerenderManifest:T,renderOpts:{experimental:{authInterrupts:!!R.experimental.authInterrupts},cacheComponents:!!R.cacheComponents,supportsDynamicResponse:q,incrementalCache:(0,r.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:R.cacheLife,waitUntil:n.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,n)=>N.onRequestError(e,t,n,A)},sharedContext:{buildId:w}},Y=new d.NodeNextRequest(e),L=new d.NodeNextResponse(t),K=p.NextRequestAdapter.fromNodeNextRequest(Y,(0,p.signalFromNodeResponse)(t));try{let i=async e=>N.handle(K,B).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=H.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=a.get("next.route");if(n){let t=`${U} ${n}`;e.setAttributes({"next.route":n,"http.route":n,"next.span_name":t}),e.updateName(t)}else e.updateName(`${U} ${b}`)}),s=!!(0,r.getRequestMeta)(e,"minimalMode"),l=async r=>{var o,l;let d=async({previousCacheEntry:a})=>{try{if(!s&&S&&D&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let o=await i(r);e.fetchMetrics=B.renderOpts.fetchMetrics;let l=B.renderOpts.pendingWaitUntil;l&&n.waitUntil&&(n.waitUntil(l),l=void 0);let d=B.renderOpts.collectedTags;if(!F)return await (0,m.sendResponse)(Y,L,o,B.renderOpts.pendingWaitUntil),null;{let e=await o.blob(),t=(0,h.toNodeOutgoingHttpHeaders)(o.headers);d&&(t[f.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==B.renderOpts.collectedRevalidate&&!(B.renderOpts.collectedRevalidate>=f.INFINITE_CACHE)&&B.renderOpts.collectedRevalidate,n=void 0===B.renderOpts.collectedExpire||B.renderOpts.collectedExpire>=f.INFINITE_CACHE?void 0:B.renderOpts.collectedExpire;return{value:{kind:g.CachedRouteKind.APP_ROUTE,status:o.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:n}}}}catch(t){throw(null==a?void 0:a.isStale)&&await N.onRequestError(e,t,{routerKind:"App Router",routePath:b,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:j,isOnDemandRevalidate:S})},A),t}},p=await N.handleResponse({req:e,nextConfig:R,cacheKey:k,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:T,isRoutePPREnabled:!1,isOnDemandRevalidate:S,revalidateOnlyGenerated:D,responseGenerator:d,waitUntil:n.waitUntil,isMinimalMode:s});if(!F)return null;if((null==p||null==(o=p.value)?void 0:o.kind)!==g.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==p||null==(l=p.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",S?"REVALIDATED":p.isMiss?"MISS":p.isStale?"STALE":"HIT"),$&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let u=(0,h.fromNodeOutgoingHttpHeaders)(p.value.headers);return s&&F||u.delete(f.NEXT_CACHE_TAGS_HEADER),!p.cacheControl||t.getHeader("Cache-Control")||u.get("Cache-Control")||u.set("Cache-Control",(0,y.getCacheControlHeader)(p.cacheControl)),await (0,m.sendResponse)(Y,L,new Response(p.value.body,{headers:u,status:p.value.status||200})),null};z?await l(z):await H.withPropagatedContext(e.headers,()=>H.trace(u.BaseServerSpan.handleRequest,{spanName:`${U} ${b}`,kind:o.SpanKind.SERVER,attributes:{"http.method":U,"http.target":e.url}},l))}catch(t){if(t instanceof v.NoFallbackError||await N.onRequestError(e,t,{routerKind:"App Router",routePath:_,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:j,isOnDemandRevalidate:S})}),F)throw t;return await (0,m.sendResponse)(Y,L,new Response(null,{status:500})),null}}e.s(["handler",()=>I,"patchFetch",()=>D,"routeModule",()=>N,"serverHooks",()=>S,"workAsyncStorage",()=>T,"workUnitAsyncStorage",()=>A],545114)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_79b9fd29.js.map
//# debugId=f9af62a3-5bf8-5757-b744-b8e525600c32
