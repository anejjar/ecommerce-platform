// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  CUSTOMER
  ADMIN
  SUPERADMIN
  MANAGER
  EDITOR
  SUPPORT
  VIEWER
}

enum OrderStatus {
  PENDING
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum PosOrderType {
  DINE_IN
  TAKE_AWAY
  DELIVERY
}

enum PosPaymentMethod {
  CASH
  CARD
  DIGITAL_WALLET
  SPLIT
}

enum PosSessionStatus {
  OPEN
  CLOSED
}

model User {
  id                    String    @id @default(cuid())
  name                  String?
  email                 String    @unique
  emailVerified         DateTime?
  image                 String?
  password              String?
  role                  UserRole  @default(CUSTOMER)
  adminNotes            String?   @db.Text
  sessionsInvalidatedAt DateTime?

  // Communication preferences (JSON: {emailMarketing, smsMarketing, orderUpdates, promotions})
  communicationPreferences String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  accounts               Account[]
  orders                 Order[]
  reviews                Review[]
  cart                   Cart?
  addresses              Address[]
  orderNotes             OrderNote[]
  passwordResets         PasswordReset[]
  newsletterSubscription NewsletterSubscriber?
  wishlistItems          WishlistItem[]
  refundsRequested       Refund[]                @relation("RefundRequestedBy")
  refundsProcessed       Refund[]                @relation("RefundProcessedBy")
  activityLogs           AdminActivityLog[]
  blogPosts              BlogPost[]
  uploadedMedia          MediaLibrary[]
  abandonedCarts         AbandonedCart[]
  paymentMethods         PaymentMethod[]
  accountDeletionRequest AccountDeletionRequest?
  stockHistory           StockHistory[]
  purchaseOrdersCreated  PurchaseOrder[]         @relation("PurchaseOrderCreatedBy")
  backups                Backup[]
  dataExports            DataExport[]
  dataImports            DataImport[]
  pages                  Page[]
  pageRevisions          PageRevision[]
  cashier                Cashier?
  posSessions            PosSession[]
  posOrders              PosOrder[]
  invoicesAsCustomer     Invoice[]              @relation("InvoiceCustomer")
  invoicesCreated        Invoice[]              @relation("InvoiceCreatedBy")
  invoicesUpdated        Invoice[]              @relation("InvoiceUpdatedBy")
  invoicePaymentsRecorded InvoicePayment[]      @relation("InvoicePaymentRecordedBy")
  invoiceHistoryChanges   InvoiceHistory[]      @relation("InvoiceHistoryChangedBy")
  recurringInvoicesAsCustomer RecurringInvoice[] @relation("RecurringInvoiceCustomer")
  recurringInvoicesCreated    RecurringInvoice[] @relation("RecurringInvoiceCreatedBy")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Category {
  id          String     @id @default(cuid())
  name        String
  slug        String     @unique
  description String?
  image       String?
  parentId    String?
  parent      Category?  @relation("CategoryToCategory", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryToCategory")
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  products            Product[]
  translations        CategoryTranslation[]
  flashSaleCategories FlashSaleCategory[]
}

model Product {
  id           String   @id @default(cuid())
  name         String
  slug         String   @unique
  description  String?  @db.Text
  price        Decimal  @db.Decimal(10, 2)
  comparePrice Decimal? @db.Decimal(10, 2)
  sku          String?  @unique
  stock        Int      @default(0)
  featured     Boolean  @default(false)
  published    Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  categoryId String?
  category   Category? @relation(fields: [categoryId], references: [id])

  images              ProductImage[]
  variants            ProductVariant[]
  variantOptions      VariantOption[]
  reviews             Review[]
  orderItems          OrderItem[]
  cartItems           CartItem[]
  stockAlert          StockAlert?
  wishlistItems       WishlistItem[]
  translations        ProductTranslation[]
  customizationFields ProductCustomizationField[]
  stockHistory        StockHistory[]
  flashSaleProducts   FlashSaleProduct[]
  invoiceItems        InvoiceItem[]
}

model ProductImage {
  id        String   @id @default(cuid())
  url       String
  alt       String?
  position  Int      @default(0)
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
}

// Variant Option (e.g., Color, Size)
model VariantOption {
  id        String               @id @default(cuid())
  name      String // e.g., "Color", "Size"
  position  Int                  @default(0)
  productId String
  product   Product              @relation(fields: [productId], references: [id], onDelete: Cascade)
  values    VariantOptionValue[]
  createdAt DateTime             @default(now())
  updatedAt DateTime             @updatedAt
}

// Variant Option Value (e.g., Red, Blue for Color)
model VariantOptionValue {
  id        String        @id @default(cuid())
  value     String // e.g., "Red", "Small"
  position  Int           @default(0)
  optionId  String
  option    VariantOption @relation(fields: [optionId], references: [id], onDelete: Cascade)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
}

// Product Variant (combination of option values)
model ProductVariant {
  id           String      @id @default(cuid())
  sku          String?     @unique
  price        Decimal?    @db.Decimal(10, 2) // If null, uses product base price
  comparePrice Decimal?    @db.Decimal(10, 2)
  stock        Int         @default(0)
  image        String? // Variant-specific image
  optionValues String // JSON array of selected values, e.g., ["Red", "Small"]
  productId    String
  product      Product     @relation(fields: [productId], references: [id], onDelete: Cascade)
  orderItems   OrderItem[]
  cartItems    CartItem[]
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
}

model Cart {
  id        String     @id @default(cuid())
  userId    String     @unique
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  items     CartItem[]
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
}

model CartItem {
  id        String          @id @default(cuid())
  quantity  Int             @default(1)
  cartId    String
  cart      Cart            @relation(fields: [cartId], references: [id], onDelete: Cascade)
  productId String
  product   Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  variantId String?
  variant   ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  customizations CartItemCustomization[]

  @@unique([cartId, productId, variantId])
}

// ===== ABANDONED CART RECOVERY =====

enum AbandonedCartStatus {
  ABANDONED
  RECOVERED
  EXPIRED
}

model AbandonedCart {
  id            String              @id @default(cuid())
  userId        String?
  user          User?               @relation(fields: [userId], references: [id], onDelete: Cascade)
  guestEmail    String?
  guestName     String?
  cartSnapshot  String              @db.Text
  totalValue    Decimal             @db.Decimal(10, 2)
  status        AbandonedCartStatus @default(ABANDONED)
  abandonedAt   DateTime            @default(now())
  recoveredAt   DateTime?
  recoveryToken String              @unique
  discountCode  String?
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  emails AbandonedCartEmail[]

  @@index([userId])
  @@index([guestEmail])
  @@index([status])
  @@index([abandonedAt])
}

model AbandonedCartEmail {
  id              String        @id @default(cuid())
  abandonedCartId String
  abandonedCart   AbandonedCart @relation(fields: [abandonedCartId], references: [id], onDelete: Cascade)
  emailType       String
  sentAt          DateTime      @default(now())
  opened          Boolean       @default(false)
  clicked         Boolean       @default(false)

  @@index([abandonedCartId])
  @@index([emailType])
}

// ==========================================

model Order {
  id             String        @id @default(cuid())
  orderNumber    String        @unique
  status         OrderStatus   @default(PENDING)
  paymentStatus  PaymentStatus @default(PENDING)
  subtotal       Decimal       @db.Decimal(10, 2)
  tax            Decimal       @default(0) @db.Decimal(10, 2)
  shipping       Decimal       @default(0) @db.Decimal(10, 2)
  total          Decimal       @db.Decimal(10, 2)
  notes          String?       @db.Text
  isGuest        Boolean       @default(false)
  guestEmail     String?
  discountCodeId String?
  discountCode   DiscountCode? @relation(fields: [discountCodeId], references: [id])
  discountAmount Decimal       @default(0) @db.Decimal(10, 2)

  // Enhanced tracking
  trackingNumber    String?
  carrier           String? // "UPS", "FedEx", "USPS", "DHL", etc.
  estimatedDelivery DateTime?
  shippedAt         DateTime?
  deliveredAt       DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId String?
  user   User?   @relation(fields: [userId], references: [id])

  items             OrderItem[]
  orderNotes        OrderNote[]
  shippingAddressId String?     @unique
  shippingAddress   Address?    @relation("ShippingAddress", fields: [shippingAddressId], references: [id])
  billingAddressId  String?     @unique
  billingAddress    Address?    @relation("BillingAddress", fields: [billingAddressId], references: [id])
  refunds           Refund[]
  isPosOrder        Boolean     @default(false)
  posOrderId        String?     @unique
  posOrder          PosOrder?   @relation(fields: [posOrderId], references: [id])
  invoices         Invoice[]
}

model OrderItem {
  id        String          @id @default(cuid())
  quantity  Int
  price     Decimal         @db.Decimal(10, 2)
  total     Decimal         @db.Decimal(10, 2)
  orderId   String
  order     Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId String
  product   Product         @relation(fields: [productId], references: [id])
  variantId String?
  variant   ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)
  createdAt DateTime        @default(now())

  customizations OrderItemCustomization[]
}

// ============================================
// POS SYSTEM MODELS
// ============================================

model Location {
  id        String   @id @default(cuid())
  name      String
  address   String?  @db.Text
  phone     String?
  isActive  Boolean  @default(true)
  settings  String?  @db.Text // JSON string for location-specific settings
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  posOrders   PosOrder[]
  cashiers    Cashier[]
  posSessions PosSession[]

  @@index([isActive])
}

model Cashier {
  id         String   @id @default(cuid())
  userId     String   @unique
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  locationId String
  location   Location @relation(fields: [locationId], references: [id])
  employeeId String?  @unique
  pin        String? // Hashed PIN for quick login
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  posOrders   PosOrder[]
  posSessions PosSession[]

  @@index([locationId])
  @@index([isActive])
}

enum PosOrderStatus {
  ACTIVE
  HELD
  COMPLETED
  CANCELLED
}

model PosOrder {
  id                  String           @id @default(cuid())
  orderType           PosOrderType
  locationId          String
  location            Location         @relation(fields: [locationId], references: [id])
  cashierId           String
  cashier             Cashier          @relation(fields: [cashierId], references: [id])
  customerId          String?
  customer            User?            @relation(fields: [customerId], references: [id])
  tableNumber         String?
  customerName        String?
  paymentMethod       PosPaymentMethod
  paymentDetails      String?          @db.Text // JSON for split payments
  receiptPrinted      Boolean          @default(false)
  subtotal            Decimal          @default(0) @db.Decimal(10, 2)
  tax                 Decimal          @default(0) @db.Decimal(10, 2)
  discount            Decimal          @default(0) @db.Decimal(10, 2)
  discountCode        String?
  discountType        String? // PERCENTAGE, FIXED_AMOUNT
  total               Decimal          @default(0) @db.Decimal(10, 2)
  status              PosOrderStatus   @default(ACTIVE)
  notes               String?          @db.Text
  specialInstructions String?          @db.Text
  orderId             String?          @unique
  order               Order?           @relation
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt

  @@index([locationId])
  @@index([cashierId])
  @@index([customerId])
  @@index([orderType])
  @@index([status])
  @@index([createdAt])
}

model PosSession {
  id           String           @id @default(cuid())
  cashierId    String
  cashier      Cashier          @relation(fields: [cashierId], references: [id])
  userId       String? // The user who opened the session (usually the cashier's user account)
  user         User?            @relation(fields: [userId], references: [id])
  locationId   String
  location     Location         @relation(fields: [locationId], references: [id])
  openedAt     DateTime         @default(now())
  closedAt     DateTime?
  openingCash  Decimal          @default(0) @db.Decimal(10, 2)
  closingCash  Decimal?         @db.Decimal(10, 2)
  expectedCash Decimal?         @db.Decimal(10, 2)
  difference   Decimal?         @db.Decimal(10, 2)
  status       PosSessionStatus @default(OPEN)
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  @@index([cashierId])
  @@index([locationId])
  @@index([status])
  @@index([openedAt])
}

model Address {
  id         String   @id @default(cuid())
  firstName  String
  lastName   String
  company    String?
  address1   String
  address2   String?
  city       String
  state      String?
  postalCode String
  country    String
  phone      String?
  isDefault  Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user          User?   @relation(fields: [userId], references: [id])
  userId        String?
  shippingOrder Order?  @relation("ShippingAddress")
  billingOrder  Order?  @relation("BillingAddress")
}

model Review {
  id        String   @id @default(cuid())
  rating    Int
  title     String?
  comment   String?  @db.Text
  verified  Boolean  @default(false)
  approved  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
}

model OrderNote {
  id         String   @id @default(cuid())
  note       String   @db.Text
  isInternal Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id])
}

model StockAlert {
  id        String   @id @default(cuid())
  threshold Int      @default(10) // Alert when stock falls below this
  notified  Boolean  @default(false)
  productId String   @unique
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================
// INVENTORY MANAGEMENT
// ============================================

enum StockChangeType {
  SALE // Stock decreased due to sale
  REFUND // Stock increased due to refund
  RESTOCK // Stock increased from supplier
  ADJUSTMENT // Manual adjustment
  DAMAGE // Stock decreased due to damage
  RETURN // Stock increased from customer return
  TRANSFER // Stock transferred between locations
}

model StockHistory {
  id        String   @id @default(cuid())
  productId String?
  product   Product? @relation(fields: [productId], references: [id], onDelete: SetNull)
  variantId String?

  changeType     StockChangeType
  quantityBefore Int
  quantityAfter  Int
  quantityChange Int // Can be positive or negative

  reason String? @db.Text
  notes  String? @db.Text

  // References
  orderId    String? // If related to sale/refund
  supplierId String? // If related to restock
  supplier   Supplier? @relation(fields: [supplierId], references: [id], onDelete: SetNull)

  userId String? // Who made the change
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@index([productId])
  @@index([variantId])
  @@index([changeType])
  @@index([createdAt])
}

model Supplier {
  id          String  @id @default(cuid())
  name        String
  contactName String?
  email       String?
  phone       String?
  address     String? @db.Text
  website     String?
  notes       String? @db.Text
  isActive    Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  stockHistory   StockHistory[]
  purchaseOrders PurchaseOrder[]

  @@index([isActive])
}

enum PurchaseOrderStatus {
  DRAFT
  PENDING
  CONFIRMED
  SHIPPED
  RECEIVED
  CANCELLED
}

model PurchaseOrder {
  id          String   @id @default(cuid())
  orderNumber String   @unique
  supplierId  String
  supplier    Supplier @relation(fields: [supplierId], references: [id])

  status PurchaseOrderStatus @default(DRAFT)

  orderDate    DateTime  @default(now())
  expectedDate DateTime?
  receivedDate DateTime?

  subtotal Decimal @db.Decimal(10, 2)
  tax      Decimal @default(0) @db.Decimal(10, 2)
  shipping Decimal @default(0) @db.Decimal(10, 2)
  total    Decimal @db.Decimal(10, 2)

  notes String? @db.Text

  createdById String?
  createdBy   User?   @relation("PurchaseOrderCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items PurchaseOrderItem[]

  @@index([supplierId])
  @@index([status])
  @@index([orderDate])
}

model PurchaseOrderItem {
  id              String        @id @default(cuid())
  purchaseOrderId String
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)

  productId String
  variantId String?

  quantity Int
  unitCost Decimal @db.Decimal(10, 2)
  total    Decimal @db.Decimal(10, 2)

  receivedQuantity Int @default(0)

  createdAt DateTime @default(now())

  @@index([purchaseOrderId])
  @@index([productId])
}

model PasswordReset {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
}

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
}

model DiscountCode {
  id             String       @id @default(cuid())
  code           String       @unique
  type           DiscountType
  value          Decimal      @db.Decimal(10, 2)
  minOrderAmount Decimal?     @db.Decimal(10, 2)
  maxUses        Int?
  usedCount      Int          @default(0)
  startDate      DateTime
  endDate        DateTime?
  isActive       Boolean      @default(true)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  orders Order[]
}

model NewsletterSubscriber {
  id             String    @id @default(cuid())
  email          String    @unique
  name           String?
  isActive       Boolean   @default(true)
  subscribedAt   DateTime  @default(now())
  unsubscribedAt DateTime?
  source         String? // e.g., "footer", "checkout", "popup"
  pageId         String? // Track which page the subscriber came from

  // Optional: Link to user account if they have one
  userId String? @unique
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  // Optional: Link to page if subscription came from a page
  page Page? @relation(fields: [pageId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([isActive])
  @@index([pageId])
}

model WishlistItem {
  id        String   @id @default(cuid())
  userId    String
  productId String
  createdAt DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([userId])
}

model StoreSetting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String   @db.Text
  category  String // e.g., "seo", "general", "social"
  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())

  @@index([category])
}

enum FeatureTier {
  FREE
  PRO
  ENTERPRISE
}

model FeatureFlag {
  id          String      @id @default(cuid())
  name        String      @unique // e.g., "analytics_dashboard"
  displayName String // e.g., "Analytics & Reporting Dashboard"
  description String?     @db.Text
  enabled     Boolean     @default(false)
  category    String // e.g., "analytics", "operations", "marketing"
  tier        FeatureTier @default(PRO)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@index([category])
  @@index([enabled])
}

// ============================================
// REGION & CITY MANAGEMENT
// ============================================

model Region {
  id        String   @id @default(cuid())
  name      String   @unique // e.g., "Casablanca-Settat", "Rabat-Salé-Kénitra"
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  cities City[]

  @@index([isActive])
}

model City {
  id        String   @id @default(cuid())
  name      String
  regionId  String
  region    Region   @relation(fields: [regionId], references: [id], onDelete: Cascade)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([name, regionId])
  @@index([regionId])
  @@index([isActive])
}

model CheckoutSettings {
  id String @id @default(cuid())

  // Field visibility toggles
  showPhone        Boolean @default(true)
  showCompany      Boolean @default(false)
  showAddressLine2 Boolean @default(true)
  requirePhone     Boolean @default(false)

  // Custom messages
  thankYouMessage    String? @db.Text
  checkoutBanner     String? @db.Text
  checkoutBannerType String? // 'info', 'warning', 'success'

  // Additional customizations
  enableGuestCheckout Boolean @default(true)
  enableOrderNotes    Boolean @default(true)
  orderNotesLabel     String?

  // Shipping options
  freeShippingThreshold Decimal? @db.Decimal(10, 2)
  defaultShippingCost   Decimal  @default(10) @db.Decimal(10, 2)

  // ===== PHASE 1: VISUAL & BRANDING =====
  // Branding
  logoUrl        String?
  primaryColor   String? @default("#000000")
  secondaryColor String? @default("#666666")
  buttonStyle    String? @default("rounded") // 'rounded', 'square', 'pill'
  fontFamily     String? @default("system") // 'system', 'inter', 'roboto', 'opensans'
  pageWidth      String? @default("normal") // 'narrow', 'normal', 'wide'

  // Layout Options
  checkoutLayout       String? @default("single") // 'single', 'multi-step'
  progressStyle        String? @default("steps") // 'steps', 'bar', 'none'
  orderSummaryPosition String? @default("right") // 'right', 'top', 'collapsible'

  // ===== PHASE 2: FIELD CUSTOMIZATION =====
  // Enhanced Field Controls
  fieldLabels       Json? // Custom labels for all fields
  fieldPlaceholders Json? // Custom placeholders
  fieldOrder        Json? // Array of field names in desired order

  // Additional Standard Fields
  showDeliveryInstructions  Boolean @default(false)
  deliveryInstructionsLabel String?
  showAlternativePhone      Boolean @default(false)
  showGiftMessage           Boolean @default(false)
  giftMessageLabel          String?
  showDeliveryDate          Boolean @default(false)

  // Custom Fields (up to 5)
  customFields Json? // Array of custom field definitions

  // ===== PHASE 4: TRUST & SECURITY =====
  // Trust Badges
  trustBadges            Json? // Array of trust badge objects {url, alt, position}
  showSecuritySeals      Boolean @default(true)
  moneyBackGuarantee     String? @db.Text
  customerServiceDisplay Boolean @default(false)
  customerServiceText    String? @db.Text
  customerServicePhone   String?
  customerServiceEmail   String?

  // Social Proof
  showOrderCount      Boolean  @default(false)
  orderCountText      String? // e.g., "X orders placed today"
  showRecentPurchases Boolean  @default(false)
  recentPurchaseDelay Int?     @default(5000) // milliseconds between popups
  showTestimonials    Boolean  @default(false)
  testimonials        Json? // Array of testimonial objects {name, text, rating, image}
  showTrustRating     Boolean  @default(false)
  trustRatingScore    Decimal? @db.Decimal(2, 1) // e.g., 4.8
  trustRatingCount    Int? // e.g., 2,453 reviews

  // ===== PHASE 5: MARKETING & CONVERSION =====
  // Promotional Features
  promotionalBanners  Json? // Array of banner objects with scheduling
  showCountdownTimer  Boolean   @default(false)
  countdownEndDate    DateTime?
  countdownText       String?
  showFreeShippingBar Boolean   @default(false)
  freeShippingBarText String? // e.g., "Add {amount} more for free shipping!"
  showUpsells         Boolean   @default(false)
  upsellProducts      Json? // Array of product IDs to show as upsells
  upsellTitle         String?
  upsellPosition      String?   @default("cart") // 'cart', 'below-form', 'modal'

  // Urgency Elements
  showLowStock      Boolean @default(false)
  lowStockThreshold Int?    @default(5)
  lowStockText      String? // e.g., "Only X left in stock!"
  scarcityMessage   String? @db.Text
  urgencyBadgeStyle String? @default("warning") // 'warning', 'danger', 'info'

  // Incentives
  discountFieldPosition   String?  @default("top") // 'top', 'bottom', 'floating'
  showLoyaltyPoints       Boolean  @default(false)
  loyaltyPointsText       String?
  showGiftWithPurchase    Boolean  @default(false)
  giftThreshold           Decimal? @db.Decimal(10, 2)
  giftDescription         String?  @db.Text
  referralDiscountEnabled Boolean  @default(false)
  referralDiscountText    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("checkout_settings")
}

enum RefundStatus {
  PENDING
  APPROVED
  REJECTED
  COMPLETED
  CANCELLED
}

enum RefundReason {
  DEFECTIVE
  WRONG_ITEM
  NOT_AS_DESCRIBED
  CHANGED_MIND
  ARRIVED_LATE
  OTHER
}

model Refund {
  id            String       @id @default(cuid())
  rmaNumber     String       @unique // Return Merchandise Authorization number
  status        RefundStatus @default(PENDING)
  reason        RefundReason
  reasonDetails String?      @db.Text
  refundAmount  Decimal      @db.Decimal(10, 2)
  restockItems  Boolean      @default(true) // Whether to restore stock
  adminNotes    String?      @db.Text
  customerNotes String?      @db.Text
  processedAt   DateTime?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  requestedById String
  requestedBy   User   @relation("RefundRequestedBy", fields: [requestedById], references: [id])

  processedById String?
  processedBy   User?   @relation("RefundProcessedBy", fields: [processedById], references: [id])

  refundItems RefundItem[]

  @@index([status])
  @@index([orderId])
}

model RefundItem {
  id       String @id @default(cuid())
  quantity Int
  refundId String
  refund   Refund @relation(fields: [refundId], references: [id], onDelete: Cascade)

  orderItemId String
  productId   String
  variantId   String?

  @@index([refundId])
}

// ===== Multi-Admin User Management =====

enum PermissionResource {
  PRODUCT
  ORDER
  CUSTOMER
  CATEGORY
  REVIEW
  DISCOUNT
  SETTINGS
  ANALYTICS
  FEATURES
  ADMIN_USER
  STOCK_ALERT
  NEWSLETTER
  REFUND
}

enum PermissionAction {
  VIEW
  CREATE
  UPDATE
  DELETE
  MANAGE
}

model Permission {
  id        String             @id @default(cuid())
  resource  PermissionResource
  action    PermissionAction
  role      UserRole
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt

  @@unique([resource, action, role])
  @@index([role])
}

model AdminInvitation {
  id         String    @id @default(cuid())
  email      String
  role       UserRole
  token      String    @unique
  expiresAt  DateTime
  acceptedAt DateTime?
  createdAt  DateTime  @default(now())

  invitedBy String

  @@index([email])
  @@index([token])
}

model AdminActivityLog {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  action     String // CREATE, UPDATE, DELETE, VIEW
  resource   String // PRODUCT, ORDER, etc.
  resourceId String?
  details    String?  @db.Text
  ipAddress  String?
  userAgent  String?  @db.Text
  createdAt  DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
  @@index([resource])
}

// ============================================
// TRANSLATION MODELS
// ============================================

model ProductTranslation {
  id              String   @id @default(cuid())
  productId       String
  product         Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  locale          String // 'en' or 'fr'
  name            String
  description     String?  @db.Text
  slug            String
  metaTitle       String?
  metaDescription String?  @db.Text
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([productId, locale])
  @@index([locale])
  @@index([slug])
}

model CategoryTranslation {
  id          String   @id @default(cuid())
  categoryId  String
  category    Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  locale      String // 'en' or 'fr'
  name        String
  description String?  @db.Text
  slug        String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([categoryId, locale])
  @@index([locale])
  @@index([slug])
}

// ============================================
// TEMPLATE MANAGEMENT
// ============================================

enum TemplateType {
  INVOICE
  PACKING_SLIP
  EMAIL_TRANSACTIONAL
  EMAIL_MARKETING
}

model Template {
  id        String       @id @default(cuid())
  name      String
  type      TemplateType
  isActive  Boolean      @default(false)
  content   String       @db.Text // JSON config for PDF, HTML for Email
  variables String?      @db.Text // Available variables description
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  @@index([type])
  @@index([isActive])
}

// ============================================
// CMS (CONTENT MANAGEMENT SYSTEM)
// ============================================

enum PostStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

model BlogPost {
  id            String     @id @default(cuid())
  title         String
  slug          String     @unique
  content       String     @db.Text
  excerpt       String?    @db.Text
  featuredImage String?
  status        PostStatus @default(DRAFT)
  publishedAt   DateTime?

  // NEW: Block-based content sections
  useBlockEditor Boolean        @default(false)
  blocks         ContentBlock[]

  // SEO
  seoTitle       String?
  seoDescription String? @db.Text

  // Relations
  authorId String
  author   User   @relation(fields: [authorId], references: [id])

  categoryId String?
  category   BlogCategory? @relation(fields: [categoryId], references: [id])

  tags BlogTag[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([slug])
  @@index([authorId])
  @@index([categoryId])
}

model BlogCategory {
  id          String  @id @default(cuid())
  name        String
  slug        String  @unique
  description String? @db.Text

  posts BlogPost[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model BlogTag {
  id   String @id @default(cuid())
  name String
  slug String @unique

  posts BlogPost[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Page {
  id                  String     @id @default(cuid())
  title               String
  slug                String     @unique
  description         String?    @db.Text
  content             String     @db.Text
  status              PageStatus @default(DRAFT)
  useStorefrontLayout Boolean    @default(true)

  // Block-based content (can be used with or instead of rich text)
  useBlockEditor Boolean        @default(false) // Toggle between rich text or blocks
  blocks         ContentBlock[]

  // SEO
  seoTitle       String?
  seoDescription String? @db.Text
  seoKeywords    String?
  ogImage        String?
  ogTitle        String?
  ogDescription  String?

  // Publishing
  publishedAt        DateTime?
  scheduledPublishAt DateTime?

  // Layout & Customization
  layoutConfig Json?    // Global page settings (width, spacing, colors, etc.)
  customCss    String?   @db.Text
  customJs     String?   @db.Text

  // Template
  templateId String?

  // Storefront Page Override
  overridesStorefrontPage Boolean @default(false)
  overriddenPageType       String? // HOME, SHOP, PRODUCT, CART, CHECKOUT, BLOG, BLOG_POST

  // Author
  authorId String?
  author   User?   @relation(fields: [authorId], references: [id], onDelete: SetNull)

  // Analytics
  viewCount      Int     @default(0)
  conversionGoal String?

  // Relations
  revisions             PageRevision[]
  newsletterSubscribers NewsletterSubscriber[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([status])
  @@index([overriddenPageType])
  @@index([authorId])
  @@index([publishedAt])
}

// ============================================
// MEDIA LIBRARY
// ============================================

enum MediaType {
  IMAGE
  VIDEO
  AUDIO
  DOCUMENT
  OTHER
}

enum MediaUsageType {
  PRODUCT_IMAGE
  PRODUCT_VARIANT
  CATEGORY_IMAGE
  BLOG_FEATURED_IMAGE
  BLOG_CONTENT
  PAGE_CONTENT
  USER_AVATAR
  STORE_SETTING
  OTHER
}

model MediaLibrary {
  id String @id @default(cuid())

  // File Information
  filename     String
  originalName String
  mimeType     String
  fileSize     Int // in bytes
  type         MediaType

  // Cloudinary Information
  cloudinaryId String  @unique
  url          String  @db.Text
  secureUrl    String  @db.Text
  publicId     String
  version      Int?
  format       String?

  // Image-specific fields
  width       Int?
  height      Int?
  aspectRatio Float?

  // Metadata
  altText     String? @db.Text
  title       String?
  caption     String? @db.Text
  description String? @db.Text

  // Organization
  folderId String?
  folder   MediaFolder? @relation(fields: [folderId], references: [id], onDelete: SetNull)
  tags     MediaTag[]

  // Tracking
  uploadedById String
  uploadedBy   User      @relation(fields: [uploadedById], references: [id])
  usageCount   Int       @default(0)
  lastUsedAt   DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  usage    MediaUsage[]
  variants MediaVariant[]

  @@index([type])
  @@index([folderId])
  @@index([uploadedById])
  @@index([createdAt])
  @@index([cloudinaryId])
  @@fulltext([filename, altText, title, caption])
}

model MediaFolder {
  id       String        @id @default(cuid())
  name     String
  slug     String
  parentId String?
  parent   MediaFolder?  @relation("FolderToFolder", fields: [parentId], references: [id])
  children MediaFolder[] @relation("FolderToFolder")

  media MediaLibrary[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([parentId, slug])
  @@index([parentId])
}

model MediaTag {
  id   String @id @default(cuid())
  name String @unique
  slug String @unique

  media MediaLibrary[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Track where media is being used
model MediaUsage {
  id String @id @default(cuid())

  mediaId String
  media   MediaLibrary @relation(fields: [mediaId], references: [id], onDelete: Cascade)

  usageType    MediaUsageType
  resourceType String // "Product", "BlogPost", "Page", etc.
  resourceId   String // ID of the resource
  fieldName    String? // e.g., "featuredImage", "content"

  createdAt DateTime @default(now())

  @@unique([mediaId, usageType, resourceType, resourceId, fieldName])
  @@index([mediaId])
  @@index([resourceType, resourceId])
}

// Store different size variants of images
model MediaVariant {
  id String @id @default(cuid())

  mediaId String
  media   MediaLibrary @relation(fields: [mediaId], references: [id], onDelete: Cascade)

  name         String // "thumbnail", "medium", "large", "custom_300x200"
  width        Int
  height       Int
  url          String  @db.Text
  cloudinaryId String?

  createdAt DateTime @default(now())

  @@unique([mediaId, name])
  @@index([mediaId])
}

// ============================================
// EXIT-INTENT POPUPS & OVERLAYS
// ============================================

enum PopupType {
  EXIT_INTENT // Triggers when mouse leaves viewport
  TIMED // Triggers after X seconds
  SCROLL_BASED // Triggers at X% scroll
  PAGE_LOAD // Triggers on page load
  CLICK_TRIGGER // Triggers on specific element click
}

enum PopupTarget {
  ALL_PAGES // Show on all pages
  HOMEPAGE // Show on homepage only
  PRODUCT_PAGES // Show on product pages
  CART_PAGE // Show on cart page
  CHECKOUT // Show on checkout
  BLOG // Show on blog pages
  CUSTOM_URL // Show on specific URLs
}

enum PopupPosition {
  CENTER // Center of screen
  TOP // Top bar
  BOTTOM // Bottom bar
  TOP_LEFT // Top left corner
  TOP_RIGHT // Top right corner
  BOTTOM_LEFT // Bottom left corner
  BOTTOM_RIGHT // Bottom right corner
}

model Popup {
  id String @id @default(cuid())

  // Basic Info
  name    String // Internal name
  title   String? // Popup title
  content String  @db.Text // HTML content

  // Type & Trigger
  type         PopupType @default(EXIT_INTENT)
  triggerValue Int? // Seconds for TIMED, % for SCROLL_BASED

  // Targeting
  target     PopupTarget @default(ALL_PAGES)
  customUrls String?     @db.Text // JSON array of URLs

  // Display Settings
  position PopupPosition @default(CENTER)
  width    Int           @default(500) // pixels
  height   Int? // pixels (null = auto)

  // Design
  backgroundColor String  @default("#ffffff")
  textColor       String  @default("#000000")
  buttonText      String  @default("Get Offer")
  buttonColor     String  @default("#000000")
  buttonTextColor String  @default("#ffffff")
  showCloseButton Boolean @default(true)
  overlayColor    String  @default("rgba(0,0,0,0.5)")

  // Image/Media
  imageUrl String?

  // Behavior
  frequency    String @default("once_per_session") // once_per_session, once_per_day, once_per_week, always
  delaySeconds Int    @default(0) // Delay before showing

  // CTA
  ctaType      String  @default("link") // link, email_capture, discount_code
  ctaUrl       String? // For link type
  discountCode String? // For discount type

  // Status & Scheduling
  isActive  Boolean   @default(false)
  startDate DateTime?
  endDate   DateTime?

  // Priority (higher number = higher priority if multiple popups match)
  priority Int @default(0)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  analytics PopupAnalytics[]

  @@index([isActive])
  @@index([type])
  @@index([target])
}

model PopupAnalytics {
  id      String @id @default(cuid())
  popupId String
  popup   Popup  @relation(fields: [popupId], references: [id], onDelete: Cascade)

  // Event tracking
  views       Int @default(0) // How many times shown
  clicks      Int @default(0) // How many times CTA clicked
  dismissals  Int @default(0) // How many times dismissed/closed
  conversions Int @default(0) // How many led to desired action

  // Date tracking (for daily aggregation)
  date DateTime @db.Date

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([popupId, date])
  @@index([popupId])
  @@index([date])
}

// ============================================
// CUSTOMER ACCOUNT FEATURES
// ============================================

// Saved payment methods (tokenized - NEVER store actual card data)
model PaymentMethod {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Payment processor info (always use tokenization)
  provider      String // "stripe", "paypal", etc.
  providerToken String // Token from payment processor

  type String // "card", "paypal", "bank_account"

  // Card info (for display only - NOT actual card data)
  cardLast4    String?
  cardBrand    String? // "visa", "mastercard", "amex", "discover"
  cardExpMonth Int?
  cardExpYear  Int?

  // Other payment method info
  email    String? // For PayPal
  bankName String? // For bank accounts

  isDefault Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([isDefault])
}

// GDPR-compliant account deletion requests
model AccountDeletionRequest {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  reason String? @db.Text
  status String  @default("pending") // pending, approved, processing, completed, cancelled

  // Deletion timing
  requestedAt DateTime  @default(now())
  scheduledAt DateTime? // When deletion will occur (e.g., 30 days from request)
  completedAt DateTime?

  // Admin review
  adminNotes   String?   @db.Text
  reviewedById String?
  reviewedAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([scheduledAt])
}

// ============================================
// PRODUCT CUSTOMIZATION & ADVANCED OPTIONS
// ============================================

enum CustomizationFieldType {
  TEXT // Short text input
  TEXTAREA // Long text area
  NUMBER // Number input
  DROPDOWN // Select from options
  RADIO // Radio buttons
  CHECKBOX // Multiple checkboxes
  COLOR // Color picker
  FILE // File upload (images for custom designs)
  DATE // Date picker
}

model ProductCustomizationField {
  id        String  @id @default(cuid())
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  // Field Configuration
  type        CustomizationFieldType
  label       String // Display label (e.g., "Engraving Text")
  placeholder String? // Placeholder text
  helpText    String? // Help text for customers
  required    Boolean                @default(false)
  position    Int                    @default(0) // Display order

  // Validation
  minLength Int? // For text fields
  maxLength Int? // For text fields
  minValue  Float? // For number fields
  maxValue  Float? // For number fields
  pattern   String? // Regex pattern for validation

  // File Upload Settings (for FILE type)
  maxFileSize  Int? // Max file size in KB
  allowedTypes String? // Comma-separated MIME types

  // Pricing
  priceModifier     Decimal @default(0) @db.Decimal(10, 2) // Fixed price to add
  priceModifierType String  @default("fixed") // "fixed" or "percentage"

  // Relations
  options                 ProductCustomizationOption[]
  cartItemCustomizations  CartItemCustomization[]
  orderItemCustomizations OrderItemCustomization[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([productId])
  @@index([position])
}

model ProductCustomizationOption {
  id      String                    @id @default(cuid())
  fieldId String
  field   ProductCustomizationField @relation(fields: [fieldId], references: [id], onDelete: Cascade)

  // Option Configuration
  label    String // Display label (e.g., "Gold")
  value    String // Actual value
  position Int    @default(0)

  // Pricing (overrides field-level pricing if set)
  priceModifier Decimal? @db.Decimal(10, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([fieldId])
  @@index([position])
}

// Stores customer customization selections in cart
model CartItemCustomization {
  id         String   @id @default(cuid())
  cartItemId String
  cartItem   CartItem @relation(fields: [cartItemId], references: [id], onDelete: Cascade)

  fieldId String
  field   ProductCustomizationField @relation(fields: [fieldId], references: [id], onDelete: Cascade)

  // Customer Input
  value    String? @db.Text // Text value or selected option value
  fileUrl  String? // Cloudinary URL for uploaded files
  fileName String? // Original filename

  // Price Calculation
  priceModifier Decimal @default(0) @db.Decimal(10, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([cartItemId])
  @@index([fieldId])
}

// Permanent record of customizations in completed orders
model OrderItemCustomization {
  id          String    @id @default(cuid())
  orderItemId String
  orderItem   OrderItem @relation(fields: [orderItemId], references: [id], onDelete: Cascade)

  // Field Info (stored permanently even if field is deleted)
  fieldId    String?
  field      ProductCustomizationField? @relation(fields: [fieldId], references: [id], onDelete: SetNull)
  fieldLabel String // Stored label in case field is deleted
  fieldType  String // Stored type

  // Customer Input
  value    String? @db.Text
  fileUrl  String? // Cloudinary URL for uploaded files
  fileName String? // Original filename

  // Price Modifier
  priceModifier Decimal @default(0) @db.Decimal(10, 2)

  createdAt DateTime @default(now())

  @@index([orderItemId])
}

// ============================================
// BACKUP & EXPORT/IMPORT
// ============================================

enum BackupType {
  MANUAL
  SCHEDULED
  AUTO
}

enum BackupStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
}

model Backup {
  id       String       @id @default(cuid())
  filename String
  fileSize Int // Size in bytes
  type     BackupType
  status   BackupStatus @default(PENDING)

  // Backup contents
  includeProducts  Boolean @default(true)
  includeOrders    Boolean @default(true)
  includeCustomers Boolean @default(true)
  includeMedia     Boolean @default(false)
  includeSettings  Boolean @default(true)

  // Storage
  fileUrl   String? // URL to backup file (Cloudinary or S3)
  localPath String? // Local file path if stored locally

  // Metadata
  recordCount  Int? // Total records backed up
  errorMessage String? @db.Text

  createdById String?
  createdBy   User?   @relation(fields: [createdById], references: [id], onDelete: SetNull)

  completedAt DateTime?
  createdAt   DateTime  @default(now())

  @@index([status])
  @@index([type])
  @@index([createdAt])
}

enum ExportStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
}

enum ExportFormat {
  CSV
  JSON
  XLSX
}

enum ExportType {
  PRODUCTS
  PRODUCT_IMAGES
  PRODUCT_VARIANTS
  ORDERS
  CUSTOMERS
  CATEGORIES
  INVENTORY
  BLOG_POSTS
  PAGES
  MEDIA_LIBRARY
  REVIEWS
  NEWSLETTER_SUBSCRIBERS
  DISCOUNT_CODES
  CUSTOM
}

model DataExport {
  id     String       @id @default(cuid())
  type   ExportType
  format ExportFormat @default(CSV)
  status ExportStatus @default(PENDING)

  // Filters (JSON string)
  filters String? @db.Text

  // Output
  filename    String?
  fileUrl     String? // Cloudinary or local URL
  fileSize    Int? // Size in bytes
  recordCount Int? // Number of records exported

  errorMessage String? @db.Text

  createdById String?
  createdBy   User?   @relation(fields: [createdById], references: [id], onDelete: SetNull)

  completedAt DateTime?
  expiresAt   DateTime? // Auto-delete after X days
  createdAt   DateTime  @default(now())

  @@index([status])
  @@index([type])
  @@index([createdAt])
  @@index([expiresAt])
}

enum ImportStatus {
  PENDING
  VALIDATING
  IN_PROGRESS
  COMPLETED
  FAILED
  PARTIAL
}

enum ImportMode {
  CREATE // Only create new records
  UPDATE // Only update existing records
  UPSERT // Create or update
}

model DataImport {
  id     String       @id @default(cuid())
  type   ExportType // Same types as export
  format ExportFormat @default(CSV)
  mode   ImportMode   @default(CREATE)
  status ImportStatus @default(PENDING)

  // Input
  filename String
  fileUrl  String // Uploaded file URL
  fileSize Int // Size in bytes

  // Results
  totalRows    Int? // Total rows in file
  successCount Int? // Successfully imported
  failedCount  Int? // Failed to import
  skippedCount Int? // Skipped (duplicates, etc.)

  // Error details (JSON array)
  errors String? @db.Text

  // Preview mode (don't actually import)
  isPreview Boolean @default(false)

  createdById String?
  createdBy   User?   @relation(fields: [createdById], references: [id], onDelete: SetNull)

  completedAt DateTime?
  createdAt   DateTime  @default(now())

  @@index([status])
  @@index([type])
  @@index([createdAt])
}

// ============================================
// SEO ADVANCED FEATURES
// ============================================

enum RedirectType {
  PERMANENT_301
  TEMPORARY_302
}

model UrlRedirect {
  id          String       @id @default(cuid())
  fromPath    String       @unique
  toPath      String
  type        RedirectType @default(PERMANENT_301)
  isActive    Boolean      @default(true)
  hitCount    Int          @default(0)
  lastHitAt   DateTime?
  notes       String?      @db.Text
  createdById String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([fromPath])
  @@index([isActive])
}

enum SchemaType {
  ORGANIZATION
  PRODUCT
  BREADCRUMB
  FAQ
  ARTICLE
  REVIEW
  LOCAL_BUSINESS
  EVENT
  RECIPE
  VIDEO
}

model SchemaMarkup {
  id          String     @id @default(cuid())
  name        String
  type        SchemaType
  isActive    Boolean    @default(true)
  schemaData  String     @db.Text
  applyToAll  Boolean    @default(false)
  targetPages String?    @db.Text
  priority    Int        @default(0)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([type])
  @@index([isActive])
}

// ============================================
// EMAIL MARKETING CAMPAIGNS
// ============================================

enum CampaignStatus {
  DRAFT
  SCHEDULED
  SENDING
  SENT
  PAUSED
  CANCELLED
}

enum CampaignType {
  NEWSLETTER
  PROMOTIONAL
  TRANSACTIONAL
  ANNOUNCEMENT
  CUSTOM
}

model EmailCampaign {
  id        String         @id @default(cuid())
  name      String
  subject   String
  preheader String?
  type      CampaignType   @default(NEWSLETTER)
  status    CampaignStatus @default(DRAFT)

  // Content
  htmlContent String  @db.Text
  textContent String? @db.Text
  templateId  String?

  // Scheduling
  scheduledAt DateTime?
  sentAt      DateTime?

  // Targeting
  sendToAll      Boolean @default(false)
  recipientCount Int     @default(0)

  // Sender info
  fromName  String?
  fromEmail String?
  replyTo   String?

  // Analytics
  totalSent         Int @default(0)
  totalOpened       Int @default(0)
  totalClicked      Int @default(0)
  totalBounced      Int @default(0)
  totalUnsubscribed Int @default(0)

  createdById String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  recipients CampaignRecipient[]
  analytics  CampaignAnalytics[]

  @@index([status])
  @@index([type])
  @@index([scheduledAt])
  @@index([createdAt])
}

model CampaignRecipient {
  id         String        @id @default(cuid())
  campaignId String
  campaign   EmailCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  email  String
  name   String?
  userId String?

  // Tracking
  sent         Boolean   @default(false)
  sentAt       DateTime?
  opened       Boolean   @default(false)
  openedAt     DateTime?
  clicked      Boolean   @default(false)
  clickedAt    DateTime?
  bounced      Boolean   @default(false)
  unsubscribed Boolean   @default(false)

  // Unique tracking token
  trackingToken String @unique

  createdAt DateTime @default(now())

  @@index([campaignId])
  @@index([email])
  @@index([trackingToken])
}

model CampaignAnalytics {
  id         String        @id @default(cuid())
  campaignId String
  campaign   EmailCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  // Event tracking
  eventType      String // "open", "click", "bounce", "unsubscribe"
  recipientEmail String
  ipAddress      String?
  userAgent      String? @db.Text
  clickedUrl     String? @db.Text

  createdAt DateTime @default(now())

  @@index([campaignId])
  @@index([eventType])
  @@index([createdAt])
}

model EmailTemplate {
  id          String  @id @default(cuid())
  name        String
  description String? @db.Text
  category    String? // "newsletter", "promotional", "transactional"

  // Content
  subject      String
  preheader    String?
  htmlContent  String  @db.Text
  textContent  String? @db.Text
  thumbnailUrl String?

  // Metadata
  isPublic   Boolean @default(false)
  usageCount Int     @default(0)

  createdById String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([category])
  @@index([isPublic])
}

// ============================================
// CMS PAGE BUILDER SYSTEM
// ============================================

enum BlockCategory {
  HERO
  CONTENT
  FEATURES
  CTA
  TESTIMONIALS
  PRICING
  TEAM
  STATS
  LOGO_GRID
  FORM
  FAQ
  GALLERY
  VIDEO
  NAVIGATION
  HEADER
  FOOTER
  SOCIAL
  BREADCRUMBS
  DIVIDER
  SPACER
  CUSTOM
  PRODUCT
  BLOG
  CONTAINER // NEW: For container blocks
  LAYOUT    // NEW: For layout blocks
}

// NEW: Container types for layout system
enum ContainerType {
  BLOCK     // Regular block (no children)
  SECTION   // Full-width section container
  FLEXBOX   // Flexbox container
  GRID      // Grid container
}

model BlockTemplate {
  id String @id @default(cuid())

  // Basic Info
  name        String
  slug        String        @unique
  description String?       @db.Text
  category    BlockCategory

  // Visual
  thumbnail  String?
  previewUrl String?

  // Configuration
  defaultConfig Json
  configSchema  Json

  // Template Code
  componentCode String  @db.Text
  htmlTemplate  String? @db.Text
  cssStyles     String? @db.Text

  // Metadata
  isSystem Boolean @default(false)
  isActive Boolean @default(true)
  isPro    Boolean @default(false)

  // Usage tracking
  usageCount Int @default(0)

  // Relations
  instances ContentBlock[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@index([isActive])
  @@index([slug])
}

model ContentBlock {
  id String @id @default(cuid())

  // Template Reference
  templateId String
  template   BlockTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  // Where is this block used? (polymorphic relationship)
  pageId String?
  page   Page?   @relation(fields: [pageId], references: [id], onDelete: Cascade)

  postId String?
  post   BlogPost? @relation(fields: [postId], references: [id], onDelete: Cascade)

  // NEW: Container/Nesting Support
  containerType ContainerType @default(BLOCK)
  parentId      String?
  parent        ContentBlock?  @relation("BlockToBlock", fields: [parentId], references: [id], onDelete: Cascade)
  children      ContentBlock[] @relation("BlockToBlock")

  // NEW: Three-Tab Configuration Structure
  contentConfig  Json  // Content tab settings (text, images, links)
  styleConfig    Json? // Style tab settings (colors, typography, spacing)
  advancedConfig Json? // Advanced tab settings (custom CSS, animations, positioning)

  // Legacy config field (for backwards compatibility - can be removed after migration)
  config Json?

  // NEW: Layout Settings (for container-type blocks)
  layoutSettings Json? // Flexbox/Grid settings (direction, gap, columns, etc.)

  // Styling Overrides
  customCss     String? @db.Text
  customClasses String?

  // Layout
  order Int @default(0)

  // Visibility
  isVisible       Boolean @default(true)
  visibilityRules Json?

  // Responsive Settings
  hideOnMobile  Boolean @default(false)
  hideOnTablet  Boolean @default(false)
  hideOnDesktop Boolean @default(false)

  // Animation
  animationType  String?
  animationDelay Int?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([pageId, order])
  @@index([postId, order])
  @@index([templateId])
  @@index([parentId])
  @@index([containerType])
}

enum PageStatus {
  DRAFT
  PUBLISHED
  SCHEDULED
  ARCHIVED
}

// LandingPage model removed - functionality merged into Page model
// LandingPageTemplate model removed - can use BlockTemplate system instead

model PageRevision {
  id String @id @default(cuid())

  // Page Reference
  pageId String
  page   Page @relation(fields: [pageId], references: [id], onDelete: Cascade)

  // Snapshot Data
  title          String
  slug           String
  description    String?    @db.Text
  content        String?    @db.Text
  seoTitle       String?
  seoDescription String?    @db.Text
  seoKeywords    String?
  ogImage        String?
  ogTitle        String?
  ogDescription  String?
  status         PageStatus
  layoutConfig   Json?
  customCss      String?    @db.Text
  customJs       String?    @db.Text
  useBlockEditor Boolean
  useStorefrontLayout Boolean

  // Blocks Snapshot (JSON array)
  blocksSnapshot Json?

  // Storefront Override Snapshot
  overridesStorefrontPage Boolean
  overriddenPageType       String?

  // Metadata
  revisionNumber Int
  note           String? @db.Text
  createdById    String
  createdBy      User    @relation(fields: [createdById], references: [id])

  // Timestamps
  createdAt DateTime @default(now())

  @@index([pageId])
  @@index([createdAt])
  @@index([revisionNumber])
}

// ============================================
// FLASH SALES & SCHEDULED PROMOTIONS
// ============================================

enum FlashSaleStatus {
  DRAFT
  SCHEDULED
  ACTIVE
  ENDED
  CANCELLED
}

model FlashSale {
  id            String          @id @default(cuid())
  name          String
  description   String?         @db.Text
  discountType  DiscountType // PERCENTAGE or FIXED_AMOUNT
  discountValue Float
  startDate     DateTime
  endDate       DateTime
  status        FlashSaleStatus @default(DRAFT)
  isActive      Boolean         @default(true)
  priority      Int             @default(0)
  bannerImage   String?
  bannerText    String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  products   FlashSaleProduct[]
  categories FlashSaleCategory[]

  @@index([status])
  @@index([startDate])
  @@index([endDate])
  @@index([isActive])
  @@index([priority])
}

model FlashSaleProduct {
  id            String   @id @default(cuid())
  flashSaleId   String
  productId     String
  originalPrice Decimal  @db.Decimal(10, 2)
  salePrice     Decimal  @db.Decimal(10, 2)
  maxQuantity   Int?
  soldQuantity  Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  flashSale FlashSale @relation(fields: [flashSaleId], references: [id], onDelete: Cascade)
  product   Product   @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([flashSaleId, productId])
  @@index([flashSaleId])
  @@index([productId])
}

model FlashSaleCategory {
  id          String   @id @default(cuid())
  flashSaleId String
  categoryId  String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  flashSale FlashSale @relation(fields: [flashSaleId], references: [id], onDelete: Cascade)
  category  Category  @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([flashSaleId, categoryId])
  @@index([flashSaleId])
  @@index([categoryId])
}

// ============================================
// PREMIUM INVOICE MANAGEMENT SYSTEM
// ============================================

enum InvoiceType {
  STANDARD
  PROFORMA
  CREDIT_NOTE
  QUOTE
  RECURRING
  RECEIPT
}

enum InvoiceStatus {
  DRAFT
  SENT
  VIEWED
  PAID
  PARTIALLY_PAID
  OVERDUE
  CANCELLED
  REFUNDED
}

enum RecurringFrequency {
  DAILY
  WEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
  CUSTOM
}

model Invoice {
  id String @id @default(cuid())

  // Invoice Identification
  invoiceNumber String @unique
  invoiceType   InvoiceType @default(STANDARD)
  status        InvoiceStatus @default(DRAFT)

  // Dates
  invoiceDate DateTime @default(now())
  dueDate     DateTime?
  sentAt      DateTime?
  viewedAt    DateTime?
  paidAt      DateTime?

  // Customer Information
  customerId String?
  customer   User?   @relation("InvoiceCustomer", fields: [customerId], references: [id], onDelete: SetNull)
  customerEmail String?
  customerName  String?
  customerCompany String?

  // Billing Address (stored as JSON for flexibility)
  billingAddress Json?

  // Shipping Address (optional)
  shippingAddress Json?

  // Order Reference (if invoice created from order)
  orderId String?
  order   Order? @relation(fields: [orderId], references: [id], onDelete: SetNull)

  // Financial Information
  subtotal       Decimal @db.Decimal(10, 2)
  tax            Decimal @default(0) @db.Decimal(10, 2)
  taxRate        Decimal? @db.Decimal(5, 2) // Tax percentage
  shipping       Decimal @default(0) @db.Decimal(10, 2)
  discount       Decimal @default(0) @db.Decimal(10, 2)
  discountType   String? // PERCENTAGE, FIXED_AMOUNT
  total           Decimal @db.Decimal(10, 2)
  amountPaid      Decimal @default(0) @db.Decimal(10, 2)
  balanceDue      Decimal @db.Decimal(10, 2)

  // Currency
  currency      String @default("USD")
  currencySymbol String @default("$")

  // Template & Customization
  templateId String?
  template   InvoiceTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)

  // Custom Fields (JSON)
  customFields Json?

  // Terms & Conditions
  termsAndConditions String? @db.Text
  notes              String? @db.Text
  footerText         String? @db.Text

  // Payment Information
  paymentMethod    String?
  paymentInstructions String? @db.Text
  paymentLink      String? // Link to payment gateway

  // Recurring Invoice Configuration
  isRecurring      Boolean @default(false)
  recurringId      String? // Reference to RecurringInvoice
  recurringInvoice RecurringInvoice? @relation(fields: [recurringId], references: [id], onDelete: SetNull)

  // QR Code
  qrCodeUrl String?

  // Digital Signature
  signatureUrl String?
  signedAt     DateTime?
  signedBy     String?

  // Metadata
  createdById String?
  createdBy   User?   @relation("InvoiceCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
  updatedById String?
  updatedBy   User?   @relation("InvoiceUpdatedBy", fields: [updatedById], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  items    InvoiceItem[]
  payments InvoicePayment[]
  history  InvoiceHistory[]

  @@index([invoiceNumber])
  @@index([status])
  @@index([invoiceType])
  @@index([customerId])
  @@index([orderId])
  @@index([invoiceDate])
  @@index([dueDate])
  @@index([createdAt])
  @@index([recurringId])
}

model InvoiceItem {
  id String @id @default(cuid())

  invoiceId String
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  // Product Information
  productId String?
  product   Product? @relation(fields: [productId], references: [id], onDelete: SetNull)
  variantId String?

  // Item Details
  description String
  sku         String?
  quantity    Int
  unitPrice   Decimal @db.Decimal(10, 2)
  taxRate     Decimal? @db.Decimal(5, 2)
  discount    Decimal @default(0) @db.Decimal(10, 2)
  total       Decimal @db.Decimal(10, 2)

  // Custom Fields (JSON)
  customFields Json?

  // Position/Order
  position Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([invoiceId])
  @@index([productId])
  @@index([position])
}

model InvoiceSettings {
  id String @id @default(cuid())

  // General Settings
  invoiceNumberPrefix String @default("INV")
  invoiceNumberFormat String @default("{{prefix}}-{{number}}") // Template for numbering
  nextInvoiceNumber   Int    @default(1)
  defaultTerms        String? @db.Text
  defaultNotes        String? @db.Text
  defaultDueDays      Int     @default(30) // Days until due date

  // Branding
  logoUrl        String?
  companyName    String?
  companyAddress String? @db.Text
  companyPhone   String?
  companyEmail   String?
  companyWebsite String?
  companyTaxId   String?

  // Colors & Styling
  primaryColor   String @default("#000000")
  secondaryColor String @default("#666666")
  accentColor    String @default("#3182ce")
  fontFamily     String @default("Helvetica")
  fontSize       Int    @default(10)

  // Template Settings
  defaultTemplateId String?

  // Email Settings
  emailSubjectTemplate String? @default("Invoice {{invoiceNumber}} from {{companyName}}")
  emailBodyTemplate    String? @db.Text
  autoSendOnCreate     Boolean @default(false)
  sendCopyToAdmin      Boolean @default(false)
  adminEmail            String?

  // Tax Settings
  defaultTaxRate Decimal? @db.Decimal(5, 2)
  taxLabel       String   @default("Tax")
  showTaxBreakdown Boolean @default(true)
  
  // Currency Settings
  currency      String @default("USD")
  currencySymbol String @default("$")

  // Payment Settings
  paymentMethods Json? // Array of available payment methods
  showPaymentLink Boolean @default(true)
  paymentGateway String? // Integration with payment gateway

  // Advanced Settings
  showQRCode        Boolean @default(false)
  enableSignatures Boolean @default(false)
  customFields      Json? // Custom field definitions
  multiLanguage     Boolean @default(false)
  defaultLanguage   String  @default("en")

  // Footer & Header
  headerText String? @db.Text
  footerText String? @db.Text
  showFooter Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([id])
}

model InvoiceTemplate {
  id String @id @default(cuid())

  // Template Info
  name        String
  description String? @db.Text
  isDefault   Boolean @default(false)
  isSystem    Boolean @default(false) // System templates cannot be deleted

  // Template Configuration (JSON)
  config Json // Contains layout, colors, fonts, sections, etc.

  // Preview
  previewImage String?

  // Usage
  usageCount Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  invoices Invoice[]
  recurringInvoices RecurringInvoice[] @relation("RecurringInvoiceTemplate")

  @@index([isDefault])
  @@index([isSystem])
}

model InvoicePayment {
  id String @id @default(cuid())

  invoiceId String
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  // Payment Details
  amount      Decimal @db.Decimal(10, 2)
  paymentDate DateTime @default(now())
  paymentMethod String // "cash", "card", "bank_transfer", "paypal", "stripe", etc.
  transactionId String? // External transaction ID
  referenceNumber String?

  // Payment Status
  status String @default("completed") // "pending", "completed", "failed", "refunded"

  // Notes
  notes String? @db.Text

  // Recorded By
  recordedById String?
  recordedBy   User?   @relation("InvoicePaymentRecordedBy", fields: [recordedById], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([invoiceId])
  @@index([paymentDate])
  @@index([status])
}

model InvoiceHistory {
  id String @id @default(cuid())

  invoiceId String
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  // Change Details
  action     String // "created", "updated", "sent", "viewed", "paid", "cancelled", etc.
  fieldName  String? // Which field was changed
  oldValue   String? @db.Text
  newValue   String? @db.Text
  description String? @db.Text

  // Changed By
  changedById String?
  changedBy   User?   @relation("InvoiceHistoryChangedBy", fields: [changedById], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@index([invoiceId])
  @@index([createdAt])
  @@index([action])
}

model RecurringInvoice {
  id String @id @default(cuid())

  // Recurring Configuration
  name        String
  description String? @db.Text

  // Customer
  customerId String?
  customer   User?   @relation("RecurringInvoiceCustomer", fields: [customerId], references: [id], onDelete: SetNull)
  customerEmail String?

  // Frequency
  frequency       RecurringFrequency @default(MONTHLY)
  interval        Int                @default(1) // Every X days/weeks/months
  customInterval  Int? // For CUSTOM frequency
  dayOfMonth      Int? // For monthly: which day (1-31)
  dayOfWeek       Int? // For weekly: which day (0-6, Sunday = 0)

  // Template
  templateId String?
  template   InvoiceTemplate? @relation("RecurringInvoiceTemplate", fields: [templateId], references: [id], onDelete: SetNull)

  // Invoice Settings (stored as JSON to copy to generated invoices)
  invoiceSettings Json? // Contains items, amounts, addresses, etc.

  // Schedule
  startDate DateTime
  endDate   DateTime?
  nextRunDate DateTime?
  lastRunDate DateTime?

  // Status
  isActive Boolean @default(true)

  // Auto-send
  autoSend Boolean @default(true)

  // Generated Invoices
  generatedInvoices Invoice[]

  // Metadata
  createdById String?
  createdBy   User?   @relation("RecurringInvoiceCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([customerId])
  @@index([isActive])
  @@index([nextRunDate])
  @@index([startDate])
}

// ============================================
// STOREFRONT THEMES
// ============================================

model Theme {
  id          String   @id @default(cuid())
  name        String   @unique
  displayName String
  description String?  @db.Text
  version     String   @default("1.0.0")
  author      String?
  previewImage String? // URL to preview image
  isBuiltIn   Boolean  @default(false)
  isActive    Boolean  @default(false)
  themeConfig Json     // Full theme configuration JSON
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([isActive])
  @@index([isBuiltIn])
}